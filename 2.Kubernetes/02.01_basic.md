# kubernetes の基本

## 1.概要

以下のチュートリアルをオンプレ環境で確認した記録。

- [Kubernetes の基本を学ぶ](https://kubernetes.io/ja/docs/tutorials/kubernetes-basics/)

## 2.環境

バージョンを確認

```bash
$ kubectl version -o yaml
clientVersion:
  buildDate: "2023-09-13T09:35:49Z"
  compiler: gc
  gitCommit: 89a4ea3e1e4ddd7f7572286090359983e0387b2f
  gitTreeState: clean
  gitVersion: v1.28.2
  goVersion: go1.20.8
  major: "1"
  minor: "28"
  platform: linux/amd64
kustomizeVersion: v5.0.4-0.20230601165947-6ce0bf390ce3
serverVersion:
  buildDate: "2023-11-15T16:48:54Z"
  compiler: gc
  gitCommit: bae2c62678db2b5053817bc97181fcc2e8388103
  gitTreeState: clean
  gitVersion: v1.28.4
  goVersion: go1.20.11
  major: "1"
  minor: "28"
  platform: linux/amd64
```

ノードを確認

```bash
$ kubectl get nodes
NAME          STATUS   ROLES           AGE   VERSION
k8s-master    Ready    control-plane   37d   v1.28.2
k8s-worker1   Ready    <none>          37d   v1.28.2
k8s-worker2   Ready    <none>          37d   v1.28.2
```

## 3.確認事項の記録

### 3.1.アプリケーションのデプロイ

目的

- kubectl を使って、Kubernetes クラスタにコンテナ化したアプリケーションをデプロイする

デプロイメントを生成

```bash
$ kubectl create deployment kubernetes-bootcamp --image=gcr.io/google-samples/kubernetes-bootcamp:v1
deployment.apps/kubernetes-bootcamp created
```

生成したデプロイメントを確認

```bash
$ kubectl get deployments
NAME                  READY   UP-TO-DATE   AVAILABLE   AGE
kubernetes-bootcamp   1/1     1            1           21s
```

プロキシを起動（この操作は別タブ（ターミナル）で実行）

```bash
$ kubectl proxy
Starting to serve on 127.0.0.1:8001
```

プロキシを経由してポッドにアクセス（バージョンを確認）

```bash
$ curl http://localhost:8001/version
{
  "major": "1",
  "minor": "28",
  "gitVersion": "v1.28.4",
  "gitCommit": "bae2c62678db2b5053817bc97181fcc2e8388103",
  "gitTreeState": "clean",
  "buildDate": "2023-11-15T16:48:54Z",
  "goVersion": "go1.20.11",
  "compiler": "gc",
  "platform": "linux/amd64"
}
```

ポッド名を取得し環境変数に設定

```bash
$ export POD_NAME=$(kubectl get pods -o go-template --template '{{range .items}}{{.metadata.name}}{{"\n"}}{{end}}')
$ echo Name of the Pod: $POD_NAME
Name of the Pod: kubernetes-bootcamp-f95c5b745-mgt7c
```

プロキシを経由してポッドにアクセス（ポッドを参照）

```bash
$ curl http://localhost:8001/api/v1/namespaces/default/pods/$POD_NAME/
```

<details><summary>実行結果</summary>

```bash
$ curl http://localhost:8001/api/v1/namespaces/default/pods/$POD_NAME/
{
  "kind": "Pod",
  "apiVersion": "v1",
  "metadata": {
    "name": "kubernetes-bootcamp-f95c5b745-mgt7c",
    "generateName": "kubernetes-bootcamp-f95c5b745-",
    "namespace": "default",
    "uid": "9b8c504a-84c1-4c4b-a05e-548f99403216",
    "resourceVersion": "76374",
    "creationTimestamp": "2024-01-04T00:24:44Z",
    "labels": {
      "app": "kubernetes-bootcamp",
      "pod-template-hash": "f95c5b745"
    },
    "annotations": {
      "cni.projectcalico.org/podIP": "172.16.194.70/32",
      "cni.projectcalico.org/podIPs": "172.16.194.70/32"
    },
    "ownerReferences": [
      {
        "apiVersion": "apps/v1",
        "kind": "ReplicaSet",
        "name": "kubernetes-bootcamp-f95c5b745",
        "uid": "92b20cf8-6f01-474f-bc07-6e6154b2e618",
        "controller": true,
        "blockOwnerDeletion": true
      }
    ],
    "managedFields": [
      {
        "manager": "calico",
        "operation": "Update",
        "apiVersion": "v1",
        "time": "2024-01-04T00:24:44Z",
        "fieldsType": "FieldsV1",
        "fieldsV1": {
          "f:metadata": {
            "f:annotations": {
              ".": {},
              "f:cni.projectcalico.org/podIP": {},
              "f:cni.projectcalico.org/podIPs": {}
            }
          }
        },
        "subresource": "status"
      },
      {
        "manager": "kube-controller-manager",
        "operation": "Update",
        "apiVersion": "v1",
        "time": "2024-01-04T00:24:44Z",
        "fieldsType": "FieldsV1",
        "fieldsV1": {
          "f:metadata": {
            "f:generateName": {},
            "f:labels": {
              ".": {},
              "f:app": {},
              "f:pod-template-hash": {}
            },
            "f:ownerReferences": {
              ".": {},
              "k:{\"uid\":\"92b20cf8-6f01-474f-bc07-6e6154b2e618\"}": {}
            }
          },
          "f:spec": {
            "f:containers": {
              "k:{\"name\":\"kubernetes-bootcamp\"}": {
                ".": {},
                "f:image": {},
                "f:imagePullPolicy": {},
                "f:name": {},
                "f:resources": {},
                "f:terminationMessagePath": {},
                "f:terminationMessagePolicy": {}
              }
            },
            "f:dnsPolicy": {},
            "f:enableServiceLinks": {},
            "f:restartPolicy": {},
            "f:schedulerName": {},
            "f:securityContext": {},
            "f:terminationGracePeriodSeconds": {}
          }
        }
      },
      {
        "manager": "kubelet",
        "operation": "Update",
        "apiVersion": "v1",
        "time": "2024-01-04T00:24:55Z",
        "fieldsType": "FieldsV1",
        "fieldsV1": {
          "f:status": {
            "f:conditions": {
              "k:{\"type\":\"ContainersReady\"}": {
                ".": {},
                "f:lastProbeTime": {},
                "f:lastTransitionTime": {},
                "f:status": {},
                "f:type": {}
              },
              "k:{\"type\":\"Initialized\"}": {
                ".": {},
                "f:lastProbeTime": {},
                "f:lastTransitionTime": {},
                "f:status": {},
                "f:type": {}
              },
              "k:{\"type\":\"Ready\"}": {
                ".": {},
                "f:lastProbeTime": {},
                "f:lastTransitionTime": {},
                "f:status": {},
                "f:type": {}
              }
            },
            "f:containerStatuses": {},
            "f:hostIP": {},
            "f:phase": {},
            "f:podIP": {},
            "f:podIPs": {
              ".": {},
              "k:{\"ip\":\"172.16.194.70\"}": {
                ".": {},
                "f:ip": {}
              }
            },
            "f:startTime": {}
          }
        },
        "subresource": "status"
      }
    ]
  },
  "spec": {
    "volumes": [
      {
        "name": "kube-api-access-zn5mm",
        "projected": {
          "sources": [
            {
              "serviceAccountToken": {
                "expirationSeconds": 3607,
                "path": "token"
              }
            },
            {
              "configMap": {
                "name": "kube-root-ca.crt",
                "items": [
                  {
                    "key": "ca.crt",
                    "path": "ca.crt"
                  }
                ]
              }
            },
            {
              "downwardAPI": {
                "items": [
                  {
                    "path": "namespace",
                    "fieldRef": {
                      "apiVersion": "v1",
                      "fieldPath": "metadata.namespace"
                    }
                  }
                ]
              }
            }
          ],
          "defaultMode": 420
        }
      }
    ],
    "containers": [
      {
        "name": "kubernetes-bootcamp",
        "image": "gcr.io/google-samples/kubernetes-bootcamp:v1",
        "resources": {},
        "volumeMounts": [
          {
            "name": "kube-api-access-zn5mm",
            "readOnly": true,
            "mountPath": "/var/run/secrets/kubernetes.io/serviceaccount"
          }
        ],
        "terminationMessagePath": "/dev/termination-log",
        "terminationMessagePolicy": "File",
        "imagePullPolicy": "IfNotPresent"
      }
    ],
    "restartPolicy": "Always",
    "terminationGracePeriodSeconds": 30,
    "dnsPolicy": "ClusterFirst",
    "serviceAccountName": "default",
    "serviceAccount": "default",
    "nodeName": "k8s-worker1",
    "securityContext": {},
    "schedulerName": "default-scheduler",
    "tolerations": [
      {
        "key": "node.kubernetes.io/not-ready",
        "operator": "Exists",
        "effect": "NoExecute",
        "tolerationSeconds": 300
      },
      {
        "key": "node.kubernetes.io/unreachable",
        "operator": "Exists",
        "effect": "NoExecute",
        "tolerationSeconds": 300
      }
    ],
    "priority": 0,
    "enableServiceLinks": true,
    "preemptionPolicy": "PreemptLowerPriority"
  },
  "status": {
    "phase": "Running",
    "conditions": [
      {
        "type": "Initialized",
        "status": "True",
        "lastProbeTime": null,
        "lastTransitionTime": "2024-01-04T00:24:44Z"
      },
      {
        "type": "Ready",
        "status": "True",
        "lastProbeTime": null,
        "lastTransitionTime": "2024-01-04T00:24:55Z"
      },
      {
        "type": "ContainersReady",
        "status": "True",
        "lastProbeTime": null,
        "lastTransitionTime": "2024-01-04T00:24:55Z"
      },
      {
        "type": "PodScheduled",
        "status": "True",
        "lastProbeTime": null,
        "lastTransitionTime": "2024-01-04T00:24:44Z"
      }
    ],
    "hostIP": "192.168.122.182",
    "podIP": "172.16.194.70",
    "podIPs": [
      {
        "ip": "172.16.194.70"
      }
    ],
    "startTime": "2024-01-04T00:24:44Z",
    "containerStatuses": [
      {
        "name": "kubernetes-bootcamp",
        "state": {
          "running": {
            "startedAt": "2024-01-04T00:24:55Z"
          }
        },
        "lastState": {},
        "ready": true,
        "restartCount": 0,
        "image": "gcr.io/google-samples/kubernetes-bootcamp:v1",
        "imageID": "gcr.io/google-samples/kubernetes-bootcamp@sha256:0d6b8ee63bb57c5f5b6156f446b3bc3b3c143d233037f3a2f00e279c8fcc64af",
        "containerID": "containerd://f898c635f349753a2255436c8beb9d183430f2ff970f93a627342081553d233d",
        "started": true
      }
    ],
    "qosClass": "BestEffort"
  }
```

</details>
<br>
デプロイメントを削除

```bash
$ kubectl delete deployment kubernetes-bootcamp
deployment.apps "kubernetes-bootcamp" deleted
$
```

## 3.2.アプリケーションの探索

目的

- Pod とは何かを把握する
- ノードとは何かを把握する

Pod とは

- Pod は、1 つ以上のアプリケーションコンテナ(Docker など)のグループとそれらのコンテナの共有リソースを表す Kubernetes の抽象概念
- 以下を含む
  - 共有ストレージ(ボリューム)
  - ネットワーキング(クラスターに固有の IP アドレス)
  - コンテナのイメージバージョンや使用するポートなどの、各コンテナをどう動かすかに関する情報

ノードとは

- Pod を実行するワーカーマシン（仮想・物理問わず）
- ノードはマスターの管理下に置かれる
- 複数の Pod を持つことができる
- 以下が動作する
  - Kubelet: Kubernetes マスターとノード間の通信を担当するプロセス
    マシン上で実行されている Pod とコンテナを管理します。
  - コンテナランタイム: レジストリからコンテナイメージを取得し、コンテナを解凍し、アプリケーションを実行することを担当する。

デプロイメントを生成

```bash
$ kubectl create deployment kubernetes-bootcamp --image=gcr.io/google-samples/kubernetes-bootcamp:v1
deployment.apps/kubernetes-bootcamp created
```

ポッドの状態を確認

```bash
$ kubectl get pods
NAME                                  READY   STATUS    RESTARTS   AGE
kubernetes-bootcamp-f95c5b745-rjh69   1/1     Running   0          29s
```

ポッドのイベントログを確認

```bash
$ kubectl describe pods
```

<details><summary>実行結果</summary>

```bash
$ kubectl describe pods
Name:             kubernetes-bootcamp-f95c5b745-rjh69
Namespace:        default
Priority:         0
Service Account:  default
Node:             k8s-worker1/192.168.122.182
Start Time:       Thu, 04 Jan 2024 00:44:52 +0000
Labels:           app=kubernetes-bootcamp
                  pod-template-hash=f95c5b745
Annotations:      cni.projectcalico.org/podIP: 172.16.194.71/32
                  cni.projectcalico.org/podIPs: 172.16.194.71/32
Status:           Running
IP:               172.16.194.71
IPs:
  IP:           172.16.194.71
Controlled By:  ReplicaSet/kubernetes-bootcamp-f95c5b745
Containers:
  kubernetes-bootcamp:
    Container ID:   containerd://64a767a35dcd51157c618a609fe6d864cd72807abaa192e34771a41bbc83fe60
    Image:          gcr.io/google-samples/kubernetes-bootcamp:v1
    Image ID:       gcr.io/google-samples/kubernetes-bootcamp@sha256:0d6b8ee63bb57c5f5b6156f446b3bc3b3c143d233037f3a2f00e279c8fcc64af
    Port:           <none>
    Host Port:      <none>
    State:          Running
      Started:      Thu, 04 Jan 2024 00:44:53 +0000
    Ready:          True
    Restart Count:  0
    Environment:    <none>
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-6fvdr (ro)
Conditions:
  Type              Status
  Initialized       True
  Ready             True
  ContainersReady   True
  PodScheduled      True
Volumes:
  kube-api-access-6fvdr:
    Type:                    Projected (a volume that contains injected data from multiple sources)
    TokenExpirationSeconds:  3607
    ConfigMapName:           kube-root-ca.crt
    ConfigMapOptional:       <nil>
    DownwardAPI:             true
QoS Class:                   BestEffort
Node-Selectors:              <none>
Tolerations:                 node.kubernetes.io/not-ready:NoExecute op=Exists for 300s
                             node.kubernetes.io/unreachable:NoExecute op=Exists for 300s
Events:
  Type    Reason     Age   From               Message
  ----    ------     ----  ----               -------
  Normal  Scheduled  55s   default-scheduler  Successfully assigned default/kubernetes-bootcamp-f95c5b745-rjh69 to k8s-worker1
  Normal  Pulled     54s   kubelet            Container image "gcr.io/google-samples/kubernetes-bootcamp:v1" already present on machine
  Normal  Created    54s   kubelet            Created container kubernetes-bootcamp
  Normal  Started    54s   kubelet            Started container kubernetes-bootcamp
```

</details>
<br>
プロキシを起動（別タブ（ターミナル）で実行）

```bash
$ kubectl proxy
Starting to serve on 127.0.0.1:8001
```

ポッド名を取得し環境変数に設定

```bash
$ export POD_NAME=$(kubectl get pods -o go-template --template '{{range .items}}{{.metadata.name}}{{"\n"}}{{end}}'))
$ echo Name of the Pod: $POD_NAME
Name of the Pod: kubernetes-bootcamp-f95c5b745-rjh69
```

プロキシ経由でポッドにアクセス

```bash
$ curl http://localhost:8001/api/v1/namespaces/default/pods/$POD_NAME/proxy/
```

_エンドポイント pod から接続拒否のエラー_

```bash
$ curl http://localhost:8001/api/v1/namespaces/default/pods/$POD_NAME/proxy/
{
  "kind": "Status",
  "apiVersion": "v1",
  "metadata": {},
  "status": "Failure",
  "message": "error trying to reach service: dial tcp 172.16.219.196:80: connect: connection refused",
  "reason": "ServiceUnavailable",
  "code": 503
}
```

_本来ならこうなる予定_

```bash
$ curl http://localhost:8001/api/v1/namespaces/default/pods/$PO_NAME/proxy/
Hello Kubernetes bootcamp! | Running on: kubernetes-bootcamp-fb5c67579-sgr55 | v=1
```

エラー対処

- 原因
  - ポッド名は IP アドレスに置き換えられる。
  - デフォルトでは`<ip>:80`で置き換えるが、docker gcr.io/google-samples/kubernetes-bootcamp:v1 内のサービスが期待しているのは`:8080`であるため。
- 対処
  - `$POD_NAME`を`$POD_NAME:8080`（ポート番号指定）に変更する

再実行結果

```bash
$ curl http://localhost:8001/api/v1/namespaces/default/pods/$POD_NAME:8080/proxy/
Hello Kubernetes bootcamp! | Running on: kubernetes-bootcamp-f95c5b745-rjh69 | v=1
```

ポッドのログを確認

```bash
$ kubectl logs $POD_NAME
Kubernetes Bootcamp App Started At: 2024-01-04T00:44:53.444Z | Running On:  kubernetes-bootcamp-f95c5b745-rjh69

Running On: kubernetes-bootcamp-f95c5b745-rjh69 | Total Requests: 1 | App Uptime: 2205.017 seconds | Log Time: 2024-01-04T01:21:38.461Z
```

ポッドの環境変数を確認

```bash
$ kubectl exec $POD_NAME -- env
PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
HOSTNAME=kubernetes-bootcamp-f95c5b745-rjh69
NPM_CONFIG_LOGLEVEL=info
NODE_VERSION=6.3.1
KUBERNETES_PORT=tcp://10.96.0.1:443
KUBERNETES_PORT_443_TCP=tcp://10.96.0.1:443
KUBERNETES_PORT_443_TCP_PROTO=tcp
KUBERNETES_PORT_443_TCP_PORT=443
KUBERNETES_PORT_443_TCP_ADDR=10.96.0.1
KUBERNETES_SERVICE_HOST=10.96.0.1
KUBERNETES_SERVICE_PORT=443
KUBERNETES_SERVICE_PORT_HTTPS=443
HOME=/root
```

ポッドに接続し bash を起動

```bash
$ kubectl exec -ti $POD_NAME -- bash
```

<details><summary>実行結果</summary>

```bash
$ kubectl exec -ti $POD_NAME -- bash
root@kubernetes-bootcamp-f95c5b745-rjh69:/# hostname
kubernetes-bootcamp-f95c5b745-rjh69
root@kubernetes-bootcamp-f95c5b745-rjh69:/# pwd
/
root@kubernetes-bootcamp-f95c5b745-rjh69:/# cat server.js
var http = require('http');
var requests=0;
var podname= process.env.HOSTNAME;
var startTime;
var host;
var handleRequest = function(request, response) {
  response.setHeader('Content-Type', 'text/plain');
  response.writeHead(200);
  response.write("Hello Kubernetes bootcamp! | Running on: ");
  response.write(host);
  response.end(" | v=1\n");
  console.log("Running On:" ,host, "| Total Requests:", ++requests,"| App Uptime:", (new Date() - startTime)/1000 , "seconds", "| Log Time:",new Date());
}
var www = http.createServer(handleRequest);
www.listen(8080,function () {
    startTime = new Date();;
    host = process.env.HOSTNAME;
    console.log ("Kubernetes Bootcamp App Started At:",startTime, "| Running On: " ,host, "\n" );
});
root@kubernetes-bootcamp-f95c5b745-rjh69:/# curl localhost:8080
Hello Kubernetes bootcamp! | Running on: kubernetes-bootcamp-f95c5b745-rjh69 | v=1
root@kubernetes-bootcamp-f95c5b745-rjh69:/# exit
exit
```

</details>
<br>
デプロイメントを削除

```bash
$ kubectl delete deployment kubernetes-bootcamp
deployment.apps "kubernetes-bootcamp" deleted
```

## 3.3.アプリケーションの公開

デプロイメントを生成

```bash
$ kubectl create deployment kubernetes-bootcamp --image=gcr.io/google-samples/kubernetes-bootcamp:v1
deployment.apps/kubernetes-bootcamp created
```

ポッドの状態を確認

```bash
$ kubectl get pods
NAME                                  READY   STATUS    RESTARTS   AGE
kubernetes-bootcamp-f95c5b745-q2t69   1/1     Running   0          36s
```

サービスの状態を確認（デプロイメント前）

```bash
$ kubectl get services
NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE
kubernetes   ClusterIP   10.96.0.1    <none>        443/TCP   37d
```

NodePort サービスを生成

```bash
$ kubectl expose deployment/kubernetes-bootcamp --type="NodePort" --port 8080
service/kubernetes-bootcamp exposed
```

サービスの状態を確認

_NodePort サービスが起動している_

```bash
$ kubectl get services
NAME                  TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE
kubernetes            ClusterIP   10.96.0.1       <none>        443/TCP          37d
kubernetes-bootcamp   NodePort    10.104.131.76   <none>        8080:30196/TCP   10m
```

サービスの定義を確認

```bash
$ kubectl describe services/kubernetes-bootcamp
Name:                     kubernetes-bootcamp
Namespace:                default
Labels:                   app=kubernetes-bootcamp
Annotations:              <none>
Selector:                 app=kubernetes-bootcamp
Type:                     NodePort
IP Family Policy:         SingleStack
IP Families:              IPv4
IP:                       10.104.131.76
IPs:                      10.104.131.76
Port:                     <unset>  8080/TCP
TargetPort:               8080/TCP
NodePort:                 <unset>  30196/TCP
Endpoints:                172.16.194.72:8080
Session Affinity:         None
External Traffic Policy:  Cluster
Events:                   <none>
```

ノードのポート番号を環境変数に設定

```bash
$ export NODE_PORT=$(kubectl get services/kubernetes-bootcamp -o go-template='{{(index .spec.ports 0).nodePort}}')
$ echo NODE_PORT=$NODE_PORT
NODE_PORT=31053
```

ポッドに NodePort サービス経由でアクセス

```bash
$ curl 192.168.122.181:$NODE_PORT
Hello Kubernetes bootcamp! | Running on: kubernetes-bootcamp-f95c5b745-q2t69 | v=1
```

デプロイメントのイベントログを確認（ポッドのラベル設定前）

```bash
$ kubectl describe deployment
```

<details><summary>実行結果</summary>

```bash
$ kubectl describe deployment
Name:                   kubernetes-bootcamp
Namespace:              default
CreationTimestamp:      Thu, 04 Jan 2024 01:47:18 +0000
Labels:                 app=kubernetes-bootcamp
Annotations:            deployment.kubernetes.io/revision: 1
Selector:               app=kubernetes-bootcamp
Replicas:               1 desired | 1 updated | 1 total | 1 available | 0 unavailable
StrategyType:           RollingUpdate
MinReadySeconds:        0
RollingUpdateStrategy:  25% max unavailable, 25% max surge
Pod Template:
  Labels:  app=kubernetes-bootcamp
  Containers:
   kubernetes-bootcamp:
    Image:        gcr.io/google-samples/kubernetes-bootcamp:v1
    Port:         <none>
    Host Port:    <none>
    Environment:  <none>
    Mounts:       <none>
  Volumes:        <none>
Conditions:
  Type           Status  Reason
  ----           ------  ------
  Available      True    MinimumReplicasAvailable
  Progressing    True    NewReplicaSetAvailable
OldReplicaSets:  <none>
NewReplicaSet:   kubernetes-bootcamp-f95c5b745 (1/1 replicas created)
Events:
  Type    Reason             Age   From                   Message
  ----    ------             ----  ----                   -------
  Normal  ScalingReplicaSet  17m   deployment-controller  Scaled up replica set kubernetes-bootcamp-f95c5b745 to 1
```

</details>
<br>
ポッドの状態を確認（ポッド指定）

```bash
$ kubectl get pods -l app=kubernetes-bootcamp
NAME                                  READY   STATUS    RESTARTS   AGE
kubernetes-bootcamp-f95c5b745-q2t69   1/1     Running   0          17m
```

サービスの状態を確認（ポッド指定）

```bash
$ kubectl get services -l app=kubernetes-bootcamp
NAME                  TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE
kubernetes-bootcamp   NodePort   10.104.131.76   <none>        8080:30196/TCP   15m
```

ポッド名を取得し環境変数に設定

```bash
$ export POD_NAME=$(kubectl get pods -o go-template --template '{{range .items}}{{.metadata.name}}{{"\n"}}{{end}}')
$ echo Name of the Pod: $POD_NAME
Name of the Pod: kubernetes-bootcamp-f95c5b745-q2t69
```

ポッドにラベルを設定

```bash
$ kubectl label pods $POD_NAME version=v1
pod/kubernetes-bootcamp-f95c5b745-q2t69 labeled
```

デプロイメントのイベントログを確認（ポッドのラベル設定後）

_Name が設定したラベル名に置き換わり Labels が追加されている_

```bash
$ kubectl describe pods $POD_NAME
```

<details><summary>実行結果</summary>

```bash
$ kubectl describe pods $POD_NAME
Name:             kubernetes-bootcamp-f95c5b745-q2t69
Namespace:        default
Priority:         0
Service Account:  default
Node:             k8s-worker1/192.168.122.182
Start Time:       Thu, 04 Jan 2024 01:47:18 +0000
Labels:           app=kubernetes-bootcamp
                  pod-template-hash=f95c5b745
                  version=v1
Annotations:      cni.projectcalico.org/podIP: 172.16.194.72/32
                  cni.projectcalico.org/podIPs: 172.16.194.72/32
Status:           Running
IP:               172.16.194.72
IPs:
  IP:           172.16.194.72
Controlled By:  ReplicaSet/kubernetes-bootcamp-f95c5b745
Containers:
  kubernetes-bootcamp:
    Container ID:   containerd://ccd75bae7cca2a417155a4eb04dff446e03cd7cc803221abfc3c23affcf96e6d
    Image:          gcr.io/google-samples/kubernetes-bootcamp:v1
    Image ID:       gcr.io/google-samples/kubernetes-bootcamp@sha256:0d6b8ee63bb57c5f5b6156f446b3bc3b3c143d233037f3a2f00e279c8fcc64af
    Port:           <none>
    Host Port:      <none>
    State:          Running
      Started:      Thu, 04 Jan 2024 01:47:19 +0000
    Ready:          True
    Restart Count:  0
    Environment:    <none>
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-gkcqw (ro)
Conditions:
  Type              Status
  Initialized       True
  Ready             True
  ContainersReady   True
  PodScheduled      True
Volumes:
  kube-api-access-gkcqw:
    Type:                    Projected (a volume that contains injected data from multiple sources)
    TokenExpirationSeconds:  3607
    ConfigMapName:           kube-root-ca.crt
    ConfigMapOptional:       <nil>
    DownwardAPI:             true
QoS Class:                   BestEffort
Node-Selectors:              <none>
Tolerations:                 node.kubernetes.io/not-ready:NoExecute op=Exists for 300s
                             node.kubernetes.io/unreachable:NoExecute op=Exists for 300s
Events:
  Type    Reason     Age   From               Message
  ----    ------     ----  ----               -------
  Normal  Scheduled  19m   default-scheduler  Successfully assigned default/kubernetes-bootcamp-f95c5b745-q2t69 to k8s-worker1
  Normal  Pulled     19m   kubelet            Container image "gcr.io/google-samples/kubernetes-bootcamp:v1" already present on machine
  Normal  Created    19m   kubelet            Created container kubernetes-bootcamp
  Normal  Started    19m   kubelet            Started container kubernetes-bootcamp
```

</details>
<br>
ラベル設定前後の差分

```diff_bash
Labels:           app=kubernetes-bootcamp
+                  pod-template-hash=f95c5b745
+                  version=v1
```

ポッドの状態を確認（ラベル指定）

```bash
$ kubectl get pods -l version=v1
NAME                                  READY   STATUS    RESTARTS   AGE
kubernetes-bootcamp-f95c5b745-q2t69   1/1     Running   0          22m
```

サービスを削除

```bash
$ kubectl delete service -l app=kubernetes-bootcamp
service "kubernetes-bootcamp" deleted
```

サービスの状態を確認

```bash
$ kubectl get services
NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE
kubernetes   ClusterIP   10.96.0.1    <none>        443/TCP   37d
```

サービス削除後のポッドへのアクセス

```bash
$ curl 192.168.122.181:$NODE_PORT
curl: (7) Failed to connect to 192.168.122.181 port 30196 after 0 ms: Connection refused
```

ポッドに接続し curl でアクセス

```bash
$ kubectl exec -ti $POD_NAME -- curl localhost:8080
Hello Kubernetes bootcamp! | Running on: kubernetes-bootcamp-f95c5b745-q2t69 | v=1
```

デプロイメントを削除

```bash
$ kubectl delete deployment kubernetes-bootcamp
deployment.apps "kubernetes-bootcamp" deleted
```

## 3.4.アプリケーションのスケーリング

デプロイメントを生成

```bash
$ kubectl create deployment kubernetes-bootcamp --image=gcr.io/google-samples/kubernetes-bootcamp:v1
deployment.apps/kubernetes-bootcamp created
```

NodePort サービスを生成

```bash
$ kubectl expose deployment/kubernetes-bootcamp --type="NodePort" --port 8080
```

デプロイメントの確認

```bash
$ kubectl get deployments
NAME                  READY   UP-TO-DATE   AVAILABLE   AGE
kubernetes-bootcamp   1/1     1            1           12s
```

デプロイメントのレプリカセットを確認

_レプリカ数が 1 で起動している_

```bash
$ kubectl get rs
NAME                             DESIRED   CURRENT   READY   AGE
kubernetes-bootcamp-855d5cc575   1         1         1       8m45s
```

スケールを設定（レプリカ数=4）

```bash
$ kubectl scale deployments/kubernetes-bootcamp --replicas=4
deployment.apps/kubernetes-bootcamp scaled
```

デプロイメントの確認

_レプリカ数が 4 に変わっている_

```bash
$ kubectl get deployments
NAME                  READY   UP-TO-DATE   AVAILABLE   AGE
kubernetes-bootcamp   4/4     4            4           2m50s
```

ポッドを確認

```bash
$ kubectl get pods -o wide
NAME                                  READY   STATUS    RESTARTS   AGE     IP              NODE          NOMINATED NODE   READINESS GATES
kubernetes-bootcamp-f95c5b745-2hmrj   1/1     Running   0          72s     172.16.126.12   k8s-worker2   <none>           <none>
kubernetes-bootcamp-f95c5b745-8mzmd   1/1     Running   0          72s     172.16.126.13   k8s-worker2   <none>           <none>
kubernetes-bootcamp-f95c5b745-m9v4c   1/1     Running   0          3m30s   172.16.194.73   k8s-worker1   <none>           <none>
kubernetes-bootcamp-f95c5b745-qc4sk   1/1     Running   0          72s     172.16.194.74   k8s-worker1   <none>           <none>
```

デプロイメントのイベントログを確認

```bash
$ kubectl describe deployments/kubernetes-bootcamp
```

_レプリカ数が 1 から 4 に変わったログが記録されている_

<details><summary>実行結果</summary>

```bash
$ kubectl describe deployments/kubernetes-bootcamp
Name:                   kubernetes-bootcamp
Namespace:              default
CreationTimestamp:      Thu, 04 Jan 2024 05:37:52 +0000
Labels:                 app=kubernetes-bootcamp
Annotations:            deployment.kubernetes.io/revision: 1
Selector:               app=kubernetes-bootcamp
Replicas:               4 desired | 4 updated | 4 total | 4 available | 0 unavailable
StrategyType:           RollingUpdate
MinReadySeconds:        0
RollingUpdateStrategy:  25% max unavailable, 25% max surge
Pod Template:
  Labels:  app=kubernetes-bootcamp
  Containers:
   kubernetes-bootcamp:
    Image:        gcr.io/google-samples/kubernetes-bootcamp:v1
    Port:         <none>
    Host Port:    <none>
    Environment:  <none>
    Mounts:       <none>
  Volumes:        <none>
Conditions:
  Type           Status  Reason
  ----           ------  ------
  Progressing    True    NewReplicaSetAvailable
  Available      True    MinimumReplicasAvailable
OldReplicaSets:  <none>
NewReplicaSet:   kubernetes-bootcamp-f95c5b745 (4/4 replicas created)
Events:
  Type    Reason             Age    From                   Message
  ----    ------             ----   ----                   -------
  Normal  ScalingReplicaSet  4m28s  deployment-controller  Scaled up replica set kubernetes-bootcamp-f95c5b745 to 1
  Normal  ScalingReplicaSet  2m10s  deployment-controller  Scaled up replica set kubernetes-bootcamp-f95c5b745 to 4 from 1
```

</details>
<br>
ノードのポート番号を取得し環境変数に設定

```bash
$ export NODE_PORT=$(kubectl get services/kubernetes-bootcamp -o go-template='{{(index .spec.ports 0).nodePort}}')
[bravog@bravo55 ~]$ echo $NODE_PORT
32404
```

ノードポート経由でポッドにアクセス

```bash
$ curl 192.168.122.181:$NODE_PORT
Hello Kubernetes bootcamp! | Running on: kubernetes-bootcamp-f95c5b745-8mzmd | v=1
```

スケールを変更（レプリカ数=2）

```bash
$ kubectl scale deployments/kubernetes-bootcamp --replicas=2
deployment.apps/kubernetes-bootcamp scaled
```

デプロイメントを確認

```bash
$ kubectl get deployments
NAME                  READY   UP-TO-DATE   AVAILABLE   AGE
kubernetes-bootcamp   2/2     2            2           11m
```

ポッドの状態を確認

```bash
$ kubectl get pods -o wide
NAME                                  READY   STATUS    RESTARTS   AGE   IP              NODE          NOMINATED NODE   READINESS GATES
kubernetes-bootcamp-f95c5b745-m9v4c   1/1     Running   0          12m   172.16.194.73   k8s-worker1   <none>           <none>
kubernetes-bootcamp-f95c5b745-qc4sk   1/1     Running   0          10m   172.16.194.74   k8s-worker1   <none>           <none>
```

デプロイメントを削除

```bash
$ kubectl delete deployment kubernetes-bootcamp
deployment.apps "kubernetes-bootcamp" deleted
```

NodePort サービスを削除

```bash
$ kubectl delete service kubernetes-bootcamp
service "kubernetes-bootcamp" deleted
```

## 3.5.アプリケーションのアップデート

デプロイメントを生成

```bash
$ kubectl create deployment kubernetes-bootcamp --image=gcr.io/google-samples/kubernetes-bootcamp:v1
deployment.apps/kubernetes-bootcamp created
```

ノードポートサービスを生成

```bash
$ kubectl expose deployment/kubernetes-bootcamp --type="NodePort" --port 8080
service/kubernetes-bootcamp exposed
```

スケールを変更（レプリカ数=4）

```bash
$ kubectl scale deployments/kubernetes-bootcamp --replicas=4
deployment.apps/kubernetes-bootcamp scaled
```

デプロイメントを確認

```bash
$ kubectl get deployments
NAME                  READY   UP-TO-DATE   AVAILABLE   AGE
kubernetes-bootcamp   4/4     4            4           2m21s
```

ポッドの状態を確認

```bash
$ kubectl get pods
NAME                                  READY   STATUS    RESTARTS   AGE
kubernetes-bootcamp-f95c5b745-4tbz2   1/1     Running   0          2m45s
kubernetes-bootcamp-f95c5b745-k6cqr   1/1     Running   0          36s
kubernetes-bootcamp-f95c5b745-kzdcx   1/1     Running   0          36s
kubernetes-bootcamp-f95c5b745-xn6gq   1/1     Running   0          36s
```

ポッドのイベントログを確認

```bash
$ kubectl describe pods
```

<details><summary>実行結果</summary>

```bash
$ kubectl describe pods
Name:             kubernetes-bootcamp-f95c5b745-4tbz2
Namespace:        default
Priority:         0
Service Account:  default
Node:             k8s-worker1/192.168.122.182
Start Time:       Thu, 04 Jan 2024 05:52:22 +0000
Labels:           app=kubernetes-bootcamp
                  pod-template-hash=f95c5b745
Annotations:      cni.projectcalico.org/podIP: 172.16.194.75/32
                  cni.projectcalico.org/podIPs: 172.16.194.75/32
Status:           Running
IP:               172.16.194.75
IPs:
  IP:           172.16.194.75
Controlled By:  ReplicaSet/kubernetes-bootcamp-f95c5b745
Containers:
  kubernetes-bootcamp:
    Container ID:   containerd://c262b5afaf412f8643c8f90b78fcbf2e4054c963da808572ae7a3862c946a6f9
    Image:          gcr.io/google-samples/kubernetes-bootcamp:v1
    Image ID:       gcr.io/google-samples/kubernetes-bootcamp@sha256:0d6b8ee63bb57c5f5b6156f446b3bc3b3c143d233037f3a2f00e279c8fcc64af
    Port:           <none>
    Host Port:      <none>
    State:          Running
      Started:      Thu, 04 Jan 2024 05:52:23 +0000
    Ready:          True
    Restart Count:  0
    Environment:    <none>
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-d7f6f (ro)
Conditions:
  Type              Status
  Initialized       True
  Ready             True
  ContainersReady   True
  PodScheduled      True
Volumes:
  kube-api-access-d7f6f:
    Type:                    Projected (a volume that contains injected data from multiple sources)
    TokenExpirationSeconds:  3607
    ConfigMapName:           kube-root-ca.crt
    ConfigMapOptional:       <nil>
    DownwardAPI:             true
QoS Class:                   BestEffort
Node-Selectors:              <none>
Tolerations:                 node.kubernetes.io/not-ready:NoExecute op=Exists for 300s
                             node.kubernetes.io/unreachable:NoExecute op=Exists for 300s
Events:
  Type    Reason     Age    From               Message
  ----    ------     ----   ----               -------
  Normal  Scheduled  3m39s  default-scheduler  Successfully assigned default/kubernetes-bootcamp-f95c5b745-4tbz2 to k8s-worker1
  Normal  Pulled     3m39s  kubelet            Container image "gcr.io/google-samples/kubernetes-bootcamp:v1" already present on machine
  Normal  Created    3m39s  kubelet            Created container kubernetes-bootcamp
  Normal  Started    3m39s  kubelet            Started container kubernetes-bootcamp


Name:             kubernetes-bootcamp-f95c5b745-k6cqr
Namespace:        default
Priority:         0
Service Account:  default
Node:             k8s-worker2/192.168.122.183
Start Time:       Thu, 04 Jan 2024 05:54:31 +0000
Labels:           app=kubernetes-bootcamp
                  pod-template-hash=f95c5b745
Annotations:      cni.projectcalico.org/podIP: 172.16.126.14/32
                  cni.projectcalico.org/podIPs: 172.16.126.14/32
Status:           Running
IP:               172.16.126.14
IPs:
  IP:           172.16.126.14
Controlled By:  ReplicaSet/kubernetes-bootcamp-f95c5b745
Containers:
  kubernetes-bootcamp:
    Container ID:   containerd://b947d2ba9a719bc6140c0f1e30945822775b971178f3302c71089145c65e8760
    Image:          gcr.io/google-samples/kubernetes-bootcamp:v1
    Image ID:       gcr.io/google-samples/kubernetes-bootcamp@sha256:0d6b8ee63bb57c5f5b6156f446b3bc3b3c143d233037f3a2f00e279c8fcc64af
    Port:           <none>
    Host Port:      <none>
    State:          Running
      Started:      Thu, 04 Jan 2024 05:54:32 +0000
    Ready:          True
    Restart Count:  0
    Environment:    <none>
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-7j6q7 (ro)
Conditions:
  Type              Status
  Initialized       True
  Ready             True
  ContainersReady   True
  PodScheduled      True
Volumes:
  kube-api-access-7j6q7:
    Type:                    Projected (a volume that contains injected data from multiple sources)
    TokenExpirationSeconds:  3607
    ConfigMapName:           kube-root-ca.crt
    ConfigMapOptional:       <nil>
    DownwardAPI:             true
QoS Class:                   BestEffort
Node-Selectors:              <none>
Tolerations:                 node.kubernetes.io/not-ready:NoExecute op=Exists for 300s
                             node.kubernetes.io/unreachable:NoExecute op=Exists for 300s
Events:
  Type    Reason     Age   From               Message
  ----    ------     ----  ----               -------
  Normal  Scheduled  91s   default-scheduler  Successfully assigned default/kubernetes-bootcamp-f95c5b745-k6cqr to k8s-worker2
  Normal  Pulled     91s   kubelet            Container image "gcr.io/google-samples/kubernetes-bootcamp:v1" already present on machine
  Normal  Created    91s   kubelet            Created container kubernetes-bootcamp
  Normal  Started    90s   kubelet            Started container kubernetes-bootcamp


Name:             kubernetes-bootcamp-f95c5b745-kzdcx
Namespace:        default
Priority:         0
Service Account:  default
Node:             k8s-worker1/192.168.122.182
Start Time:       Thu, 04 Jan 2024 05:54:31 +0000
Labels:           app=kubernetes-bootcamp
                  pod-template-hash=f95c5b745
Annotations:      cni.projectcalico.org/podIP: 172.16.194.76/32
                  cni.projectcalico.org/podIPs: 172.16.194.76/32
Status:           Running
IP:               172.16.194.76
IPs:
  IP:           172.16.194.76
Controlled By:  ReplicaSet/kubernetes-bootcamp-f95c5b745
Containers:
  kubernetes-bootcamp:
    Container ID:   containerd://f499ea114324aee85d5e21c7f90732dcbd3bd49f4419196612b3e30f5290a3e7
    Image:          gcr.io/google-samples/kubernetes-bootcamp:v1
    Image ID:       gcr.io/google-samples/kubernetes-bootcamp@sha256:0d6b8ee63bb57c5f5b6156f446b3bc3b3c143d233037f3a2f00e279c8fcc64af
    Port:           <none>
    Host Port:      <none>
    State:          Running
      Started:      Thu, 04 Jan 2024 05:54:31 +0000
    Ready:          True
    Restart Count:  0
    Environment:    <none>
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-46c6n (ro)
Conditions:
  Type              Status
  Initialized       True
  Ready             True
  ContainersReady   True
  PodScheduled      True
Volumes:
  kube-api-access-46c6n:
    Type:                    Projected (a volume that contains injected data from multiple sources)
    TokenExpirationSeconds:  3607
    ConfigMapName:           kube-root-ca.crt
    ConfigMapOptional:       <nil>
    DownwardAPI:             true
QoS Class:                   BestEffort
Node-Selectors:              <none>
Tolerations:                 node.kubernetes.io/not-ready:NoExecute op=Exists for 300s
                             node.kubernetes.io/unreachable:NoExecute op=Exists for 300s
Events:
  Type    Reason     Age   From               Message
  ----    ------     ----  ----               -------
  Normal  Scheduled  91s   default-scheduler  Successfully assigned default/kubernetes-bootcamp-f95c5b745-kzdcx to k8s-worker1
  Normal  Pulled     91s   kubelet            Container image "gcr.io/google-samples/kubernetes-bootcamp:v1" already present on machine
  Normal  Created    91s   kubelet            Created container kubernetes-bootcamp
  Normal  Started    91s   kubelet            Started container kubernetes-bootcamp


Name:             kubernetes-bootcamp-f95c5b745-xn6gq
Namespace:        default
Priority:         0
Service Account:  default
Node:             k8s-worker2/192.168.122.183
Start Time:       Thu, 04 Jan 2024 05:54:31 +0000
Labels:           app=kubernetes-bootcamp
                  pod-template-hash=f95c5b745
Annotations:      cni.projectcalico.org/podIP: 172.16.126.15/32
                  cni.projectcalico.org/podIPs: 172.16.126.15/32
Status:           Running
IP:               172.16.126.15
IPs:
  IP:           172.16.126.15
Controlled By:  ReplicaSet/kubernetes-bootcamp-f95c5b745
Containers:
  kubernetes-bootcamp:
    Container ID:   containerd://6f038d6ddcb93c41eed087d054fa218b088fd53906819b2739a4c94f7df70204
    Image:          gcr.io/google-samples/kubernetes-bootcamp:v1
    Image ID:       gcr.io/google-samples/kubernetes-bootcamp@sha256:0d6b8ee63bb57c5f5b6156f446b3bc3b3c143d233037f3a2f00e279c8fcc64af
    Port:           <none>
    Host Port:      <none>
    State:          Running
      Started:      Thu, 04 Jan 2024 05:54:32 +0000
    Ready:          True
    Restart Count:  0
    Environment:    <none>
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-k922l (ro)
Conditions:
  Type              Status
  Initialized       True
  Ready             True
  ContainersReady   True
  PodScheduled      True
Volumes:
  kube-api-access-k922l:
    Type:                    Projected (a volume that contains injected data from multiple sources)
    TokenExpirationSeconds:  3607
    ConfigMapName:           kube-root-ca.crt
    ConfigMapOptional:       <nil>
    DownwardAPI:             true
QoS Class:                   BestEffort
Node-Selectors:              <none>
Tolerations:                 node.kubernetes.io/not-ready:NoExecute op=Exists for 300s
                             node.kubernetes.io/unreachable:NoExecute op=Exists for 300s
Events:
  Type    Reason     Age   From               Message
  ----    ------     ----  ----               -------
  Normal  Scheduled  91s   default-scheduler  Successfully assigned default/kubernetes-bootcamp-f95c5b745-xn6gq to k8s-worker2
  Normal  Pulled     91s   kubelet            Container image "gcr.io/google-samples/kubernetes-bootcamp:v1" already present on machine
  Normal  Created    91s   kubelet            Created container kubernetes-bootcamp
  Normal  Started    90s   kubelet            Started container kubernetes-bootcamp
```

</details>
<br>
ポッドで実行するイメージを v1 から v2 に変更

```bash
$ kubectl set image deployments/kubernetes-bootcamp kubernetes-bootcamp=jocatalin/kubernetes-bootcamp:v2
deployment.apps/kubernetes-bootcamp image updated
```

ポッドの状態を確認

```bash
$ kubectl get pods
NAME                                   READY   STATUS        RESTARTS   AGE
kubernetes-bootcamp-65df967b7f-6sx74   1/1     Running       0          8s
kubernetes-bootcamp-65df967b7f-hstt8   1/1     Running       0          14s
kubernetes-bootcamp-65df967b7f-prfz4   1/1     Running       0          8s
kubernetes-bootcamp-65df967b7f-wmknv   1/1     Running       0          14s
kubernetes-bootcamp-f95c5b745-4tbz2    1/1     Terminating   0          5m7s
kubernetes-bootcamp-f95c5b745-k6cqr    1/1     Terminating   0          2m58s
kubernetes-bootcamp-f95c5b745-kzdcx    1/1     Terminating   0          2m58s
kubernetes-bootcamp-f95c5b745-xn6gq    1/1     Terminating   0          2m58s
```

_しばらくすると Pod の切り替えが完了する_

```bash
$ kubectl get pods
NAME                                   READY   STATUS    RESTARTS   AGE
kubernetes-bootcamp-65df967b7f-6sx74   1/1     Running   0          43s
kubernetes-bootcamp-65df967b7f-hstt8   1/1     Running   0          49s
kubernetes-bootcamp-65df967b7f-prfz4   1/1     Running   0          43s
kubernetes-bootcamp-65df967b7f-wmknv   1/1     Running   0          49s
```

NodePort サービスの状態を確認

```bash
$ kubectl describe services/kubernetes-bootcamp
Name:                     kubernetes-bootcamp
Namespace:                default
Labels:                   app=kubernetes-bootcamp
Annotations:              <none>
Selector:                 app=kubernetes-bootcamp
Type:                     NodePort
IP Family Policy:         SingleStack
IP Families:              IPv4
IP:                       10.110.100.237
IPs:                      10.110.100.237
Port:                     <unset>  8080/TCP
TargetPort:               8080/TCP
NodePort:                 <unset>  30330/TCP
Endpoints:                172.16.126.16:8080,172.16.126.17:8080,172.16.194.77:8080 + 1 more...
Session Affinity:         None
External Traffic Policy:  Cluster
Events:                   <none>
```

NodePort のポート番号を取得し環境変数に設定

```bash
$ export NODE_PORT=$(kubectl get services/kubernetes-bootcamp -o go-template='{{(index .spec.ports 0).nodePort}}')
$ echo $NODE_PORT
30330
```

NodePort 経由でポッドにアクセス

```bash
$ curl 192.168.122.181:$NODE_PORT
Hello Kubernetes bootcamp! | Running on: kubernetes-bootcamp-65df967b7f-prfz4 | v=2
```

イメージをロールアウト（アプリケーションを更新）

```bash
$ kubectl rollout status deployments/kubernetes-bootcamp
deployment "kubernetes-bootcamp" successfully rolled out
```

ポッドのイベントログを確認

```bash
$ kubectl describe pods
```

<details><summary>実行結果</summary>

```bash
$ kubectl describe pods
Name:             kubernetes-bootcamp-65df967b7f-6sx74
Namespace:        default
Priority:         0
Service Account:  default
Node:             k8s-worker2/192.168.122.183
Start Time:       Thu, 04 Jan 2024 05:57:21 +0000
Labels:           app=kubernetes-bootcamp
                  pod-template-hash=65df967b7f
Annotations:      cni.projectcalico.org/podIP: 172.16.126.17/32
                  cni.projectcalico.org/podIPs: 172.16.126.17/32
Status:           Running
IP:               172.16.126.17
IPs:
  IP:           172.16.126.17
Controlled By:  ReplicaSet/kubernetes-bootcamp-65df967b7f
Containers:
  kubernetes-bootcamp:
    Container ID:   containerd://76c0158d0895600706312920d846857b1589c252bdee47e6bd9c077d9a74d058
    Image:          jocatalin/kubernetes-bootcamp:v2
    Image ID:       docker.io/jocatalin/kubernetes-bootcamp@sha256:fb1a3ced00cecfc1f83f18ab5cd14199e30adc1b49aa4244f5d65ad3f5feb2a5
    Port:           <none>
    Host Port:      <none>
    State:          Running
      Started:      Thu, 04 Jan 2024 05:57:22 +0000
    Ready:          True
    Restart Count:  0
    Environment:    <none>
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-xn2m6 (ro)
Conditions:
  Type              Status
  Initialized       True
  Ready             True
  ContainersReady   True
  PodScheduled      True
Volumes:
  kube-api-access-xn2m6:
    Type:                    Projected (a volume that contains injected data from multiple sources)
    TokenExpirationSeconds:  3607
    ConfigMapName:           kube-root-ca.crt
    ConfigMapOptional:       <nil>
    DownwardAPI:             true
QoS Class:                   BestEffort
Node-Selectors:              <none>
Tolerations:                 node.kubernetes.io/not-ready:NoExecute op=Exists for 300s
                             node.kubernetes.io/unreachable:NoExecute op=Exists for 300s
Events:
  Type    Reason     Age    From               Message
  ----    ------     ----   ----               -------
  Normal  Scheduled  4m29s  default-scheduler  Successfully assigned default/kubernetes-bootcamp-65df967b7f-6sx74 to k8s-worker2
  Normal  Pulled     4m29s  kubelet            Container image "jocatalin/kubernetes-bootcamp:v2" already present on machine
  Normal  Created    4m29s  kubelet            Created container kubernetes-bootcamp
  Normal  Started    4m29s  kubelet            Started container kubernetes-bootcamp


Name:             kubernetes-bootcamp-65df967b7f-hstt8
Namespace:        default
Priority:         0
Service Account:  default
Node:             k8s-worker1/192.168.122.182
Start Time:       Thu, 04 Jan 2024 05:57:15 +0000
Labels:           app=kubernetes-bootcamp
                  pod-template-hash=65df967b7f
Annotations:      cni.projectcalico.org/podIP: 172.16.194.77/32
                  cni.projectcalico.org/podIPs: 172.16.194.77/32
Status:           Running
IP:               172.16.194.77
IPs:
  IP:           172.16.194.77
Controlled By:  ReplicaSet/kubernetes-bootcamp-65df967b7f
Containers:
  kubernetes-bootcamp:
    Container ID:   containerd://b5e0e37fe959db83f7508d8bca5dbbac653a6207c69e903dfe97098c3550188c
    Image:          jocatalin/kubernetes-bootcamp:v2
    Image ID:       docker.io/jocatalin/kubernetes-bootcamp@sha256:fb1a3ced00cecfc1f83f18ab5cd14199e30adc1b49aa4244f5d65ad3f5feb2a5
    Port:           <none>
    Host Port:      <none>
    State:          Running
      Started:      Thu, 04 Jan 2024 05:57:21 +0000
    Ready:          True
    Restart Count:  0
    Environment:    <none>
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-zl9fc (ro)
Conditions:
  Type              Status
  Initialized       True
  Ready             True
  ContainersReady   True
  PodScheduled      True
Volumes:
  kube-api-access-zl9fc:
    Type:                    Projected (a volume that contains injected data from multiple sources)
    TokenExpirationSeconds:  3607
    ConfigMapName:           kube-root-ca.crt
    ConfigMapOptional:       <nil>
    DownwardAPI:             true
QoS Class:                   BestEffort
Node-Selectors:              <none>
Tolerations:                 node.kubernetes.io/not-ready:NoExecute op=Exists for 300s
                             node.kubernetes.io/unreachable:NoExecute op=Exists for 300s
Events:
  Type    Reason     Age    From               Message
  ----    ------     ----   ----               -------
  Normal  Scheduled  4m35s  default-scheduler  Successfully assigned default/kubernetes-bootcamp-65df967b7f-hstt8 to k8s-worker1
  Normal  Pulling    4m35s  kubelet            Pulling image "jocatalin/kubernetes-bootcamp:v2"
  Normal  Pulled     4m31s  kubelet            Successfully pulled image "jocatalin/kubernetes-bootcamp:v2" in 4.744s (4.744s including waiting)
  Normal  Created    4m31s  kubelet            Created container kubernetes-bootcamp
  Normal  Started    4m30s  kubelet            Started container kubernetes-bootcamp


Name:             kubernetes-bootcamp-65df967b7f-prfz4
Namespace:        default
Priority:         0
Service Account:  default
Node:             k8s-worker1/192.168.122.182
Start Time:       Thu, 04 Jan 2024 05:57:21 +0000
Labels:           app=kubernetes-bootcamp
                  pod-template-hash=65df967b7f
Annotations:      cni.projectcalico.org/podIP: 172.16.194.78/32
                  cni.projectcalico.org/podIPs: 172.16.194.78/32
Status:           Running
IP:               172.16.194.78
IPs:
  IP:           172.16.194.78
Controlled By:  ReplicaSet/kubernetes-bootcamp-65df967b7f
Containers:
  kubernetes-bootcamp:
    Container ID:   containerd://acd3ea318b9cc3e82e1a4b4095ac221f339cfef84657e83eaa87188d8467c816
    Image:          jocatalin/kubernetes-bootcamp:v2
    Image ID:       docker.io/jocatalin/kubernetes-bootcamp@sha256:fb1a3ced00cecfc1f83f18ab5cd14199e30adc1b49aa4244f5d65ad3f5feb2a5
    Port:           <none>
    Host Port:      <none>
    State:          Running
      Started:      Thu, 04 Jan 2024 05:57:22 +0000
    Ready:          True
    Restart Count:  0
    Environment:    <none>
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-zpwpt (ro)
Conditions:
  Type              Status
  Initialized       True
  Ready             True
  ContainersReady   True
  PodScheduled      True
Volumes:
  kube-api-access-zpwpt:
    Type:                    Projected (a volume that contains injected data from multiple sources)
    TokenExpirationSeconds:  3607
    ConfigMapName:           kube-root-ca.crt
    ConfigMapOptional:       <nil>
    DownwardAPI:             true
QoS Class:                   BestEffort
Node-Selectors:              <none>
Tolerations:                 node.kubernetes.io/not-ready:NoExecute op=Exists for 300s
                             node.kubernetes.io/unreachable:NoExecute op=Exists for 300s
Events:
  Type    Reason     Age    From               Message
  ----    ------     ----   ----               -------
  Normal  Scheduled  4m29s  default-scheduler  Successfully assigned default/kubernetes-bootcamp-65df967b7f-prfz4 to k8s-worker1
  Normal  Pulled     4m29s  kubelet            Container image "jocatalin/kubernetes-bootcamp:v2" already present on machine
  Normal  Created    4m29s  kubelet            Created container kubernetes-bootcamp
  Normal  Started    4m29s  kubelet            Started container kubernetes-bootcamp


Name:             kubernetes-bootcamp-65df967b7f-wmknv
Namespace:        default
Priority:         0
Service Account:  default
Node:             k8s-worker2/192.168.122.183
Start Time:       Thu, 04 Jan 2024 05:57:15 +0000
Labels:           app=kubernetes-bootcamp
                  pod-template-hash=65df967b7f
Annotations:      cni.projectcalico.org/podIP: 172.16.126.16/32
                  cni.projectcalico.org/podIPs: 172.16.126.16/32
Status:           Running
IP:               172.16.126.16
IPs:
  IP:           172.16.126.16
Controlled By:  ReplicaSet/kubernetes-bootcamp-65df967b7f
Containers:
  kubernetes-bootcamp:
    Container ID:   containerd://35ee99b782cb2b7a1195f1b50d4292817227c27f25d744cea8c9a7a5234b5ae7
    Image:          jocatalin/kubernetes-bootcamp:v2
    Image ID:       docker.io/jocatalin/kubernetes-bootcamp@sha256:fb1a3ced00cecfc1f83f18ab5cd14199e30adc1b49aa4244f5d65ad3f5feb2a5
    Port:           <none>
    Host Port:      <none>
    State:          Running
      Started:      Thu, 04 Jan 2024 05:57:21 +0000
    Ready:          True
    Restart Count:  0
    Environment:    <none>
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-kpq54 (ro)
Conditions:
  Type              Status
  Initialized       True
  Ready             True
  ContainersReady   True
  PodScheduled      True
Volumes:
  kube-api-access-kpq54:
    Type:                    Projected (a volume that contains injected data from multiple sources)
    TokenExpirationSeconds:  3607
    ConfigMapName:           kube-root-ca.crt
    ConfigMapOptional:       <nil>
    DownwardAPI:             true
QoS Class:                   BestEffort
Node-Selectors:              <none>
Tolerations:                 node.kubernetes.io/not-ready:NoExecute op=Exists for 300s
                             node.kubernetes.io/unreachable:NoExecute op=Exists for 300s
Events:
  Type    Reason     Age    From               Message
  ----    ------     ----   ----               -------
  Normal  Scheduled  4m35s  default-scheduler  Successfully assigned default/kubernetes-bootcamp-65df967b7f-wmknv to k8s-worker2
  Normal  Pulling    4m35s  kubelet            Pulling image "jocatalin/kubernetes-bootcamp:v2"
  Normal  Pulled     4m31s  kubelet            Successfully pulled image "jocatalin/kubernetes-bootcamp:v2" in 4.704s (4.704s including waiting)
  Normal  Created    4m31s  kubelet            Created container kubernetes-bootcamp
  Normal  Started    4m30s  kubelet            Started container kubernetes-bootcamp
```

</details>
<br>
ポッドで実行するイメージを v2 から v10 に更新

_v10 を持つイメージはリポジトリに存在しないためエラーとなる_

```bash
$ kubectl set image deployments/kubernetes-bootcamp kubernetes-bootcamp=gcr.io/google-samples/kubernetes-bootcamp:v10
deployment.apps/kubernetes-bootcamp image updated
```

デプロイメントの状態を確認

```bash
$ kubectl get deployments
NAME                  READY   UP-TO-DATE   AVAILABLE   AGE
kubernetes-bootcamp   3/4     2            3           28m
```

_`READY`の数が一致していない_

ポッドの状態を確認する

```bash
$ kubectl get pods
NAME                                   READY   STATUS             RESTARTS   AGE
kubernetes-bootcamp-65df967b7f-6sx74   1/1     Running            0          9m19s
kubernetes-bootcamp-65df967b7f-prfz4   1/1     Running            0          9m19s
kubernetes-bootcamp-65df967b7f-wmknv   1/1     Running            0          9m25s
kubernetes-bootcamp-7497bc6797-ttg6h   0/1     ErrImagePull       0          37s
kubernetes-bootcamp-7497bc6797-zdz9j   0/1     ImagePullBackOff   0          37s
```

_`ImagePullBackOff`や`ErrImagePull`となっている Pod がある_

ポッドのイベントログを確認

```bash
$ kubectl describe pods
```

<details><summary>実行結果</summary>

```bash
$ kubectl describe pods
Name:             kubernetes-bootcamp-65df967b7f-6sx74
Namespace:        default
Priority:         0
Service Account:  default
Node:             k8s-worker2/192.168.122.183
Start Time:       Thu, 04 Jan 2024 05:57:21 +0000
Labels:           app=kubernetes-bootcamp
                  pod-template-hash=65df967b7f
Annotations:      cni.projectcalico.org/podIP: 172.16.126.17/32
                  cni.projectcalico.org/podIPs: 172.16.126.17/32
Status:           Running
IP:               172.16.126.17
IPs:
  IP:           172.16.126.17
Controlled By:  ReplicaSet/kubernetes-bootcamp-65df967b7f
Containers:
  kubernetes-bootcamp:
    Container ID:   containerd://76c0158d0895600706312920d846857b1589c252bdee47e6bd9c077d9a74d058
    Image:          jocatalin/kubernetes-bootcamp:v2
    Image ID:       docker.io/jocatalin/kubernetes-bootcamp@sha256:fb1a3ced00cecfc1f83f18ab5cd14199e30adc1b49aa4244f5d65ad3f5feb2a5
    Port:           <none>
    Host Port:      <none>
    State:          Running
      Started:      Thu, 04 Jan 2024 05:57:22 +0000
    Ready:          True
    Restart Count:  0
    Environment:    <none>
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-xn2m6 (ro)
Conditions:
  Type              Status
  Initialized       True
  Ready             True
  ContainersReady   True
  PodScheduled      True
Volumes:
  kube-api-access-xn2m6:
    Type:                    Projected (a volume that contains injected data from multiple sources)
    TokenExpirationSeconds:  3607
    ConfigMapName:           kube-root-ca.crt
    ConfigMapOptional:       <nil>
    DownwardAPI:             true
QoS Class:                   BestEffort
Node-Selectors:              <none>
Tolerations:                 node.kubernetes.io/not-ready:NoExecute op=Exists for 300s
                             node.kubernetes.io/unreachable:NoExecute op=Exists for 300s
Events:
  Type    Reason     Age   From               Message
  ----    ------     ----  ----               -------
  Normal  Scheduled  10m   default-scheduler  Successfully assigned default/kubernetes-bootcamp-65df967b7f-6sx74 to k8s-worker2
  Normal  Pulled     10m   kubelet            Container image "jocatalin/kubernetes-bootcamp:v2" already present on machine
  Normal  Created    10m   kubelet            Created container kubernetes-bootcamp
  Normal  Started    10m   kubelet            Started container kubernetes-bootcamp


Name:             kubernetes-bootcamp-65df967b7f-prfz4
Namespace:        default
Priority:         0
Service Account:  default
Node:             k8s-worker1/192.168.122.182
Start Time:       Thu, 04 Jan 2024 05:57:21 +0000
Labels:           app=kubernetes-bootcamp
                  pod-template-hash=65df967b7f
Annotations:      cni.projectcalico.org/podIP: 172.16.194.78/32
                  cni.projectcalico.org/podIPs: 172.16.194.78/32
Status:           Running
IP:               172.16.194.78
IPs:
  IP:           172.16.194.78
Controlled By:  ReplicaSet/kubernetes-bootcamp-65df967b7f
Containers:
  kubernetes-bootcamp:
    Container ID:   containerd://acd3ea318b9cc3e82e1a4b4095ac221f339cfef84657e83eaa87188d8467c816
    Image:          jocatalin/kubernetes-bootcamp:v2
    Image ID:       docker.io/jocatalin/kubernetes-bootcamp@sha256:fb1a3ced00cecfc1f83f18ab5cd14199e30adc1b49aa4244f5d65ad3f5feb2a5
    Port:           <none>
    Host Port:      <none>
    State:          Running
      Started:      Thu, 04 Jan 2024 05:57:22 +0000
    Ready:          True
    Restart Count:  0
    Environment:    <none>
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-zpwpt (ro)
Conditions:
  Type              Status
  Initialized       True
  Ready             True
  ContainersReady   True
  PodScheduled      True
Volumes:
  kube-api-access-zpwpt:
    Type:                    Projected (a volume that contains injected data from multiple sources)
    TokenExpirationSeconds:  3607
    ConfigMapName:           kube-root-ca.crt
    ConfigMapOptional:       <nil>
    DownwardAPI:             true
QoS Class:                   BestEffort
Node-Selectors:              <none>
Tolerations:                 node.kubernetes.io/not-ready:NoExecute op=Exists for 300s
                             node.kubernetes.io/unreachable:NoExecute op=Exists for 300s
Events:
  Type    Reason     Age   From               Message
  ----    ------     ----  ----               -------
  Normal  Scheduled  10m   default-scheduler  Successfully assigned default/kubernetes-bootcamp-65df967b7f-prfz4 to k8s-worker1
  Normal  Pulled     10m   kubelet            Container image "jocatalin/kubernetes-bootcamp:v2" already present on machine
  Normal  Created    10m   kubelet            Created container kubernetes-bootcamp
  Normal  Started    10m   kubelet            Started container kubernetes-bootcamp


Name:             kubernetes-bootcamp-65df967b7f-wmknv
Namespace:        default
Priority:         0
Service Account:  default
Node:             k8s-worker2/192.168.122.183
Start Time:       Thu, 04 Jan 2024 05:57:15 +0000
Labels:           app=kubernetes-bootcamp
                  pod-template-hash=65df967b7f
Annotations:      cni.projectcalico.org/podIP: 172.16.126.16/32
                  cni.projectcalico.org/podIPs: 172.16.126.16/32
Status:           Running
IP:               172.16.126.16
IPs:
  IP:           172.16.126.16
Controlled By:  ReplicaSet/kubernetes-bootcamp-65df967b7f
Containers:
  kubernetes-bootcamp:
    Container ID:   containerd://35ee99b782cb2b7a1195f1b50d4292817227c27f25d744cea8c9a7a5234b5ae7
    Image:          jocatalin/kubernetes-bootcamp:v2
    Image ID:       docker.io/jocatalin/kubernetes-bootcamp@sha256:fb1a3ced00cecfc1f83f18ab5cd14199e30adc1b49aa4244f5d65ad3f5feb2a5
    Port:           <none>
    Host Port:      <none>
    State:          Running
      Started:      Thu, 04 Jan 2024 05:57:21 +0000
    Ready:          True
    Restart Count:  0
    Environment:    <none>
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-kpq54 (ro)
Conditions:
  Type              Status
  Initialized       True
  Ready             True
  ContainersReady   True
  PodScheduled      True
Volumes:
  kube-api-access-kpq54:
    Type:                    Projected (a volume that contains injected data from multiple sources)
    TokenExpirationSeconds:  3607
    ConfigMapName:           kube-root-ca.crt
    ConfigMapOptional:       <nil>
    DownwardAPI:             true
QoS Class:                   BestEffort
Node-Selectors:              <none>
Tolerations:                 node.kubernetes.io/not-ready:NoExecute op=Exists for 300s
                             node.kubernetes.io/unreachable:NoExecute op=Exists for 300s
Events:
  Type    Reason     Age   From               Message
  ----    ------     ----  ----               -------
  Normal  Scheduled  10m   default-scheduler  Successfully assigned default/kubernetes-bootcamp-65df967b7f-wmknv to k8s-worker2
  Normal  Pulling    10m   kubelet            Pulling image "jocatalin/kubernetes-bootcamp:v2"
  Normal  Pulled     10m   kubelet            Successfully pulled image "jocatalin/kubernetes-bootcamp:v2" in 4.704s (4.704s including waiting)
  Normal  Created    10m   kubelet            Created container kubernetes-bootcamp
  Normal  Started    10m   kubelet            Started container kubernetes-bootcamp


Name:             kubernetes-bootcamp-7497bc6797-ttg6h
Namespace:        default
Priority:         0
Service Account:  default
Node:             k8s-worker1/192.168.122.182
Start Time:       Thu, 04 Jan 2024 06:06:03 +0000
Labels:           app=kubernetes-bootcamp
                  pod-template-hash=7497bc6797
Annotations:      cni.projectcalico.org/podIP: 172.16.194.79/32
                  cni.projectcalico.org/podIPs: 172.16.194.79/32
Status:           Pending
IP:               172.16.194.79
IPs:
  IP:           172.16.194.79
Controlled By:  ReplicaSet/kubernetes-bootcamp-7497bc6797
Containers:
  kubernetes-bootcamp:
    Container ID:
    Image:          gcr.io/google-samples/kubernetes-bootcamp:v10
    Image ID:
    Port:           <none>
    Host Port:      <none>
    State:          Waiting
      Reason:       ImagePullBackOff
    Ready:          False
    Restart Count:  0
    Environment:    <none>
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-g2d74 (ro)
Conditions:
  Type              Status
  Initialized       True
  Ready             False
  ContainersReady   False
  PodScheduled      True
Volumes:
  kube-api-access-g2d74:
    Type:                    Projected (a volume that contains injected data from multiple sources)
    TokenExpirationSeconds:  3607
    ConfigMapName:           kube-root-ca.crt
    ConfigMapOptional:       <nil>
    DownwardAPI:             true
QoS Class:                   BestEffort
Node-Selectors:              <none>
Tolerations:                 node.kubernetes.io/not-ready:NoExecute op=Exists for 300s
                             node.kubernetes.io/unreachable:NoExecute op=Exists for 300s
Events:
  Type     Reason     Age                 From               Message
  ----     ------     ----                ----               -------
  Normal   Scheduled  2m8s                default-scheduler  Successfully assigned default/kubernetes-bootcamp-7497bc6797-ttg6h to k8s-worker1
  Normal   Pulling    39s (x4 over 2m8s)  kubelet            Pulling image "gcr.io/google-samples/kubernetes-bootcamp:v10"
  Warning  Failed     39s (x4 over 2m7s)  kubelet            Failed to pull image "gcr.io/google-samples/kubernetes-bootcamp:v10": rpc error: code = NotFound desc = failed to pull and unpack image "gcr.io/google-samples/kubernetes-bootcamp:v10": failed to resolve reference "gcr.io/google-samples/kubernetes-bootcamp:v10": gcr.io/google-samples/kubernetes-bootcamp:v10: not found
  Warning  Failed     39s (x4 over 2m7s)  kubelet            Error: ErrImagePull
  Warning  Failed     24s (x6 over 2m6s)  kubelet            Error: ImagePullBackOff
  Normal   BackOff    10s (x7 over 2m6s)  kubelet            Back-off pulling image "gcr.io/google-samples/kubernetes-bootcamp:v10"


Name:             kubernetes-bootcamp-7497bc6797-zdz9j
Namespace:        default
Priority:         0
Service Account:  default
Node:             k8s-worker2/192.168.122.183
Start Time:       Thu, 04 Jan 2024 06:06:03 +0000
Labels:           app=kubernetes-bootcamp
                  pod-template-hash=7497bc6797
Annotations:      cni.projectcalico.org/podIP: 172.16.126.18/32
                  cni.projectcalico.org/podIPs: 172.16.126.18/32
Status:           Pending
IP:               172.16.126.18
IPs:
  IP:           172.16.126.18
Controlled By:  ReplicaSet/kubernetes-bootcamp-7497bc6797
Containers:
  kubernetes-bootcamp:
    Container ID:
    Image:          gcr.io/google-samples/kubernetes-bootcamp:v10
    Image ID:
    Port:           <none>
    Host Port:      <none>
    State:          Waiting
      Reason:       ImagePullBackOff
    Ready:          False
    Restart Count:  0
    Environment:    <none>
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-xbdrd (ro)
Conditions:
  Type              Status
  Initialized       True
  Ready             False
  ContainersReady   False
  PodScheduled      True
Volumes:
  kube-api-access-xbdrd:
    Type:                    Projected (a volume that contains injected data from multiple sources)
    TokenExpirationSeconds:  3607
    ConfigMapName:           kube-root-ca.crt
    ConfigMapOptional:       <nil>
    DownwardAPI:             true
QoS Class:                   BestEffort
Node-Selectors:              <none>
Tolerations:                 node.kubernetes.io/not-ready:NoExecute op=Exists for 300s
                             node.kubernetes.io/unreachable:NoExecute op=Exists for 300s
Events:
  Type     Reason     Age                 From               Message
  ----     ------     ----                ----               -------
  Normal   Scheduled  2m8s                default-scheduler  Successfully assigned default/kubernetes-bootcamp-7497bc6797-zdz9j to k8s-worker2
  Normal   Pulling    43s (x4 over 2m8s)  kubelet            Pulling image "gcr.io/google-samples/kubernetes-bootcamp:v10"
  Warning  Failed     42s (x4 over 2m7s)  kubelet            Failed to pull image "gcr.io/google-samples/kubernetes-bootcamp:v10": rpc error: code = NotFound desc = failed to pull and unpack image "gcr.io/google-samples/kubernetes-bootcamp:v10": failed to resolve reference "gcr.io/google-samples/kubernetes-bootcamp:v10": gcr.io/google-samples/kubernetes-bootcamp:v10: not found
  Warning  Failed     42s (x4 over 2m7s)  kubelet            Error: ErrImagePull
  Warning  Failed     28s (x6 over 2m6s)  kubelet            Error: ImagePullBackOff
  Normal   BackOff    17s (x7 over 2m6s)  kubelet            Back-off pulling image "gcr.io/google-samples/kubernetes-bootcamp:v10"
```

</details>

_一部のポッドで`Failed`イベントを記録している_
<br>
ロールアウトを取り消す（ロールバック）

```bash
$ kubectl rollout undo deployments/kubernetes-bootcamp
deployment.apps/kubernetes-bootcamp rolled back
```

ポッドの状態を確認

```bash
$ kubectl get pods
NAME                                   READY   STATUS    RESTARTS   AGE
kubernetes-bootcamp-65df967b7f-6sx74   1/1     Running   0          13m
kubernetes-bootcamp-65df967b7f-prfz4   1/1     Running   0          13m
kubernetes-bootcamp-65df967b7f-wmknv   1/1     Running   0          13m
kubernetes-bootcamp-65df967b7f-xp5hf   1/1     Running   0          10s
```

ポッドのイベントログを確認

```bash
$ kubectl describe pods
```

<details><summary>実行結果</summary>

```bash
$ kubectl describe pods
Name:             kubernetes-bootcamp-65df967b7f-6sx74
Namespace:        default
Priority:         0
Service Account:  default
Node:             k8s-worker2/192.168.122.183
Start Time:       Thu, 04 Jan 2024 05:57:21 +0000
Labels:           app=kubernetes-bootcamp
                  pod-template-hash=65df967b7f
Annotations:      cni.projectcalico.org/podIP: 172.16.126.17/32
                  cni.projectcalico.org/podIPs: 172.16.126.17/32
Status:           Running
IP:               172.16.126.17
IPs:
  IP:           172.16.126.17
Controlled By:  ReplicaSet/kubernetes-bootcamp-65df967b7f
Containers:
  kubernetes-bootcamp:
    Container ID:   containerd://76c0158d0895600706312920d846857b1589c252bdee47e6bd9c077d9a74d058
    Image:          jocatalin/kubernetes-bootcamp:v2
    Image ID:       docker.io/jocatalin/kubernetes-bootcamp@sha256:fb1a3ced00cecfc1f83f18ab5cd14199e30adc1b49aa4244f5d65ad3f5feb2a5
    Port:           <none>
    Host Port:      <none>
    State:          Running
      Started:      Thu, 04 Jan 2024 05:57:22 +0000
    Ready:          True
    Restart Count:  0
    Environment:    <none>
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-xn2m6 (ro)
Conditions:
  Type              Status
  Initialized       True
  Ready             True
  ContainersReady   True
  PodScheduled      True
Volumes:
  kube-api-access-xn2m6:
    Type:                    Projected (a volume that contains injected data from multiple sources)
    TokenExpirationSeconds:  3607
    ConfigMapName:           kube-root-ca.crt
    ConfigMapOptional:       <nil>
    DownwardAPI:             true
QoS Class:                   BestEffort
Node-Selectors:              <none>
Tolerations:                 node.kubernetes.io/not-ready:NoExecute op=Exists for 300s
                             node.kubernetes.io/unreachable:NoExecute op=Exists for 300s
Events:
  Type    Reason     Age   From               Message
  ----    ------     ----  ----               -------
  Normal  Scheduled  13m   default-scheduler  Successfully assigned default/kubernetes-bootcamp-65df967b7f-6sx74 to k8s-worker2
  Normal  Pulled     13m   kubelet            Container image "jocatalin/kubernetes-bootcamp:v2" already present on machine
  Normal  Created    13m   kubelet            Created container kubernetes-bootcamp
  Normal  Started    13m   kubelet            Started container kubernetes-bootcamp


Name:             kubernetes-bootcamp-65df967b7f-prfz4
Namespace:        default
Priority:         0
Service Account:  default
Node:             k8s-worker1/192.168.122.182
Start Time:       Thu, 04 Jan 2024 05:57:21 +0000
Labels:           app=kubernetes-bootcamp
                  pod-template-hash=65df967b7f
Annotations:      cni.projectcalico.org/podIP: 172.16.194.78/32
                  cni.projectcalico.org/podIPs: 172.16.194.78/32
Status:           Running
IP:               172.16.194.78
IPs:
  IP:           172.16.194.78
Controlled By:  ReplicaSet/kubernetes-bootcamp-65df967b7f
Containers:
  kubernetes-bootcamp:
    Container ID:   containerd://acd3ea318b9cc3e82e1a4b4095ac221f339cfef84657e83eaa87188d8467c816
    Image:          jocatalin/kubernetes-bootcamp:v2
    Image ID:       docker.io/jocatalin/kubernetes-bootcamp@sha256:fb1a3ced00cecfc1f83f18ab5cd14199e30adc1b49aa4244f5d65ad3f5feb2a5
    Port:           <none>
    Host Port:      <none>
    State:          Running
      Started:      Thu, 04 Jan 2024 05:57:22 +0000
    Ready:          True
    Restart Count:  0
    Environment:    <none>
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-zpwpt (ro)
Conditions:
  Type              Status
  Initialized       True
  Ready             True
  ContainersReady   True
  PodScheduled      True
Volumes:
  kube-api-access-zpwpt:
    Type:                    Projected (a volume that contains injected data from multiple sources)
    TokenExpirationSeconds:  3607
    ConfigMapName:           kube-root-ca.crt
    ConfigMapOptional:       <nil>
    DownwardAPI:             true
QoS Class:                   BestEffort
Node-Selectors:              <none>
Tolerations:                 node.kubernetes.io/not-ready:NoExecute op=Exists for 300s
                             node.kubernetes.io/unreachable:NoExecute op=Exists for 300s
Events:
  Type    Reason     Age   From               Message
  ----    ------     ----  ----               -------
  Normal  Scheduled  13m   default-scheduler  Successfully assigned default/kubernetes-bootcamp-65df967b7f-prfz4 to k8s-worker1
  Normal  Pulled     13m   kubelet            Container image "jocatalin/kubernetes-bootcamp:v2" already present on machine
  Normal  Created    13m   kubelet            Created container kubernetes-bootcamp
  Normal  Started    13m   kubelet            Started container kubernetes-bootcamp


Name:             kubernetes-bootcamp-65df967b7f-wmknv
Namespace:        default
Priority:         0
Service Account:  default
Node:             k8s-worker2/192.168.122.183
Start Time:       Thu, 04 Jan 2024 05:57:15 +0000
Labels:           app=kubernetes-bootcamp
                  pod-template-hash=65df967b7f
Annotations:      cni.projectcalico.org/podIP: 172.16.126.16/32
                  cni.projectcalico.org/podIPs: 172.16.126.16/32
Status:           Running
IP:               172.16.126.16
IPs:
  IP:           172.16.126.16
Controlled By:  ReplicaSet/kubernetes-bootcamp-65df967b7f
Containers:
  kubernetes-bootcamp:
    Container ID:   containerd://35ee99b782cb2b7a1195f1b50d4292817227c27f25d744cea8c9a7a5234b5ae7
    Image:          jocatalin/kubernetes-bootcamp:v2
    Image ID:       docker.io/jocatalin/kubernetes-bootcamp@sha256:fb1a3ced00cecfc1f83f18ab5cd14199e30adc1b49aa4244f5d65ad3f5feb2a5
    Port:           <none>
    Host Port:      <none>
    State:          Running
      Started:      Thu, 04 Jan 2024 05:57:21 +0000
    Ready:          True
    Restart Count:  0
    Environment:    <none>
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-kpq54 (ro)
Conditions:
  Type              Status
  Initialized       True
  Ready             True
  ContainersReady   True
  PodScheduled      True
Volumes:
  kube-api-access-kpq54:
    Type:                    Projected (a volume that contains injected data from multiple sources)
    TokenExpirationSeconds:  3607
    ConfigMapName:           kube-root-ca.crt
    ConfigMapOptional:       <nil>
    DownwardAPI:             true
QoS Class:                   BestEffort
Node-Selectors:              <none>
Tolerations:                 node.kubernetes.io/not-ready:NoExecute op=Exists for 300s
                             node.kubernetes.io/unreachable:NoExecute op=Exists for 300s
Events:
  Type    Reason     Age   From               Message
  ----    ------     ----  ----               -------
  Normal  Scheduled  14m   default-scheduler  Successfully assigned default/kubernetes-bootcamp-65df967b7f-wmknv to k8s-worker2
  Normal  Pulling    14m   kubelet            Pulling image "jocatalin/kubernetes-bootcamp:v2"
  Normal  Pulled     14m   kubelet            Successfully pulled image "jocatalin/kubernetes-bootcamp:v2" in 4.704s (4.704s including waiting)
  Normal  Created    14m   kubelet            Created container kubernetes-bootcamp
  Normal  Started    13m   kubelet            Started container kubernetes-bootcamp


Name:             kubernetes-bootcamp-65df967b7f-xp5hf
Namespace:        default
Priority:         0
Service Account:  default
Node:             k8s-worker1/192.168.122.182
Start Time:       Thu, 04 Jan 2024 06:10:26 +0000
Labels:           app=kubernetes-bootcamp
                  pod-template-hash=65df967b7f
Annotations:      cni.projectcalico.org/podIP: 172.16.194.80/32
                  cni.projectcalico.org/podIPs: 172.16.194.80/32
Status:           Running
IP:               172.16.194.80
IPs:
  IP:           172.16.194.80
Controlled By:  ReplicaSet/kubernetes-bootcamp-65df967b7f
Containers:
  kubernetes-bootcamp:
    Container ID:   containerd://20b15a7b011ac5b722b875b9a82039678b5cac3608a867c334268931ccdbda90
    Image:          jocatalin/kubernetes-bootcamp:v2
    Image ID:       docker.io/jocatalin/kubernetes-bootcamp@sha256:fb1a3ced00cecfc1f83f18ab5cd14199e30adc1b49aa4244f5d65ad3f5feb2a5
    Port:           <none>
    Host Port:      <none>
    State:          Running
      Started:      Thu, 04 Jan 2024 06:10:26 +0000
    Ready:          True
    Restart Count:  0
    Environment:    <none>
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-pjt8p (ro)
Conditions:
  Type              Status
  Initialized       True
  Ready             True
  ContainersReady   True
  PodScheduled      True
Volumes:
  kube-api-access-pjt8p:
    Type:                    Projected (a volume that contains injected data from multiple sources)
    TokenExpirationSeconds:  3607
    ConfigMapName:           kube-root-ca.crt
    ConfigMapOptional:       <nil>
    DownwardAPI:             true
QoS Class:                   BestEffort
Node-Selectors:              <none>
Tolerations:                 node.kubernetes.io/not-ready:NoExecute op=Exists for 300s
                             node.kubernetes.io/unreachable:NoExecute op=Exists for 300s
Events:
  Type    Reason     Age   From               Message
  ----    ------     ----  ----               -------
  Normal  Scheduled  54s   default-scheduler  Successfully assigned default/kubernetes-bootcamp-65df967b7f-xp5hf to k8s-worker1
  Normal  Pulled     54s   kubelet            Container image "jocatalin/kubernetes-bootcamp:v2" already present on machine
  Normal  Created    54s   kubelet            Created container kubernetes-bootcamp
  Normal  Started    54s   kubelet            Started container kubernetes-bootcamp
```

</details>

_ロールバック操作により v2 に戻っている_
<br>
デプロイメントを削除

```bash
$ kubectl delete deployment kubernetes-bootcamp
```

ノードポートサービスを削除

```bash
$ kubectl delete service kubernetes-bootcamp
```
