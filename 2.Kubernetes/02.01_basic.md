# kubernetes の基本

## 1.概要

以下のチュートリアルをオンプレ環境で確認した記録。

- [Kubernetes の基本を学ぶ](https://kubernetes.io/ja/docs/tutorials/kubernetes-basics/)

## 2.環境

バージョンを確認

```bash
$ kubectl version -o json
{
  "clientVersion": {
    "major": "1",
    "minor": "27",
    "gitVersion": "v1.27.1",
    "gitCommit": "4c9411232e10168d7b050c49a1b59f6df9d7ea4b",
    "gitTreeState": "clean",
    "buildDate": "2023-04-14T13:21:19Z",
    "goVersion": "go1.20.3",
    "compiler": "gc",
    "platform": "linux/amd64"
  },
  "kustomizeVersion": "v5.0.1",
  "serverVersion": {
    "major": "1",
    "minor": "27",
    "gitVersion": "v1.27.1",
    "gitCommit": "4c9411232e10168d7b050c49a1b59f6df9d7ea4b",
    "gitTreeState": "clean",
    "buildDate": "2023-04-14T13:14:42Z",
    "goVersion": "go1.20.3",
    "compiler": "gc",
    "platform": "linux/amd64"
  }
}
```

ノードを確認

```bash
$ kubectl get nodes
NAME                      STATUS   ROLES           AGE    VERSION
k8s-master.localdomain    Ready    control-plane   2d1h   v1.27.1
k8s-worker1.localdomain   Ready    <none>          2d1h   v1.27.1
k8s-worker2.localdomain   Ready    <none>          2d1h   v1.27.1
$
```

## 3.確認事項の記録

### 3.1.アプリケーションのデプロイ

デプロイメントを生成

```bash
$ kubectl create deployment kubernetes-bootcamp --image=gcr.io/google-samples/kubernetes-bootcamp:v1
deployment.apps/kubernetes-bootcamp created
```

生成したデプロイメントを確認

```bash
$ kubectl get deployments
NAME                  READY   UP-TO-DATE   AVAILABLE   AGE
kubernetes-bootcamp   1/1     1            1           21s
```

プロキシを起動

_別タブ（ターミナル）で実行_

```bash
$ kubectl proxy
```

プロキシを経由してポッドにアクセス（バージョンを確認）

```bash
$ curl http://localhost:8001/version
{
  "major": "1",
  "minor": "27",
  "gitVersion": "v1.27.1",
  "gitCommit": "4c9411232e10168d7b050c49a1b59f6df9d7ea4b",
  "gitTreeState": "clean",
  "buildDate": "2023-04-14T13:14:42Z",
  "goVersion": "go1.20.3",
  "compiler": "gc",
  "platform": "linux/amd64"
}
```

ポッド名を取得し環境変数に設定

```bash
$ export POD_NAME=$(kubectl get pods -o go-template --template '{{range .items}}{{.metadata.name}}{{"\n"}}{{end}}')
$ echo Name of the Pod: $POD_NAME
Name of the Pod: kubernetes-bootcamp-855d5cc575-qn6dl
```

プロキシを経由してポッドにアクセス（ポッドを参照）

```bash
$ curl http://localhost:8001/api/v1/namespaces/default/pods/$POD_NAME/
```

<details><summary>実行結果</summary>

```bash
$ curl http://localhost:8001/api/v1/namespaces/default/pods/$POD_NAME/
{
  "kind": "Pod",
  "apiVersion": "v1",
  "metadata": {
    "name": "kubernetes-bootcamp-855d5cc575-qn6dl",
    "generateName": "kubernetes-bootcamp-855d5cc575-",
    "namespace": "default",
    "uid": "c09cd845-8179-4356-a34d-de61ee980ff2",
    "resourceVersion": "32691",
    "creationTimestamp": "2023-05-03T02:32:21Z",
    "labels": {
      "app": "kubernetes-bootcamp",
      "pod-template-hash": "855d5cc575"
    },
    "annotations": {
      "cni.projectcalico.org/containerID": "83ec94d2c42fecd8e72b84b406c71973e3fefd767ed25b3308b09a06fe64db7c",
      "cni.projectcalico.org/podIP": "172.16.219.196/32",
      "cni.projectcalico.org/podIPs": "172.16.219.196/32"
    },
    "ownerReferences": [
      {
        "apiVersion": "apps/v1",
        "kind": "ReplicaSet",
        "name": "kubernetes-bootcamp-855d5cc575",
        "uid": "b4630c16-45f2-43cf-b811-512560d1f685",
        "controller": true,
        "blockOwnerDeletion": true
      }
    ],
    "managedFields": [
      {
        "manager": "kube-controller-manager",
        "operation": "Update",
        "apiVersion": "v1",
        "time": "2023-05-03T02:32:21Z",
        "fieldsType": "FieldsV1",
        "fieldsV1": {
          "f:metadata": {
            "f:generateName": {},
            "f:labels": {
              ".": {},
              "f:app": {},
              "f:pod-template-hash": {}
            },
            "f:ownerReferences": {
              ".": {},
              "k:{\"uid\":\"b4630c16-45f2-43cf-b811-512560d1f685\"}": {}
            }
          },
          "f:spec": {
            "f:containers": {
              "k:{\"name\":\"kubernetes-bootcamp\"}": {
                ".": {},
                "f:image": {},
                "f:imagePullPolicy": {},
                "f:name": {},
                "f:resources": {},
                "f:terminationMessagePath": {},
                "f:terminationMessagePolicy": {}
              }
            },
            "f:dnsPolicy": {},
            "f:enableServiceLinks": {},
            "f:restartPolicy": {},
            "f:schedulerName": {},
            "f:securityContext": {},
            "f:terminationGracePeriodSeconds": {}
          }
        }
      },
      {
        "manager": "calico",
        "operation": "Update",
        "apiVersion": "v1",
        "time": "2023-05-03T02:32:22Z",
        "fieldsType": "FieldsV1",
        "fieldsV1": {
          "f:metadata": {
            "f:annotations": {
              ".": {},
              "f:cni.projectcalico.org/containerID": {},
              "f:cni.projectcalico.org/podIP": {},
              "f:cni.projectcalico.org/podIPs": {}
            }
          }
        },
        "subresource": "status"
      },
      {
        "manager": "kubelet",
        "operation": "Update",
        "apiVersion": "v1",
        "time": "2023-05-03T02:32:23Z",
        "fieldsType": "FieldsV1",
        "fieldsV1": {
          "f:status": {
            "f:conditions": {
              "k:{\"type\":\"ContainersReady\"}": {
                ".": {},
                "f:lastProbeTime": {},
                "f:lastTransitionTime": {},
                "f:status": {},
                "f:type": {}
              },
              "k:{\"type\":\"Initialized\"}": {
                ".": {},
                "f:lastProbeTime": {},
                "f:lastTransitionTime": {},
                "f:status": {},
                "f:type": {}
              },
              "k:{\"type\":\"Ready\"}": {
                ".": {},
                "f:lastProbeTime": {},
                "f:lastTransitionTime": {},
                "f:status": {},
                "f:type": {}
              }
            },
            "f:containerStatuses": {},
            "f:hostIP": {},
            "f:phase": {},
            "f:podIP": {},
            "f:podIPs": {
              ".": {},
              "k:{\"ip\":\"172.16.219.196\"}": {
                ".": {},
                "f:ip": {}
              }
            },
            "f:startTime": {}
          }
        },
        "subresource": "status"
      }
    ]
  },
  "spec": {
    "volumes": [
      {
        "name": "kube-api-access-5zpns",
        "projected": {
          "sources": [
            {
              "serviceAccountToken": {
                "expirationSeconds": 3607,
                "path": "token"
              }
            },
            {
              "configMap": {
                "name": "kube-root-ca.crt",
                "items": [
                  {
                    "key": "ca.crt",
                    "path": "ca.crt"
                  }
                ]
              }
            },
            {
              "downwardAPI": {
                "items": [
                  {
                    "path": "namespace",
                    "fieldRef": {
                      "apiVersion": "v1",
                      "fieldPath": "metadata.namespace"
                    }
                  }
                ]
              }
            }
          ],
          "defaultMode": 420
        }
      }
    ],
    "containers": [
      {
        "name": "kubernetes-bootcamp",
        "image": "gcr.io/google-samples/kubernetes-bootcamp:v1",
        "resources": {},
        "volumeMounts": [
          {
            "name": "kube-api-access-5zpns",
            "readOnly": true,
            "mountPath": "/var/run/secrets/kubernetes.io/serviceaccount"
          }
        ],
        "terminationMessagePath": "/dev/termination-log",
        "terminationMessagePolicy": "File",
        "imagePullPolicy": "IfNotPresent"
      }
    ],
    "restartPolicy": "Always",
    "terminationGracePeriodSeconds": 30,
    "dnsPolicy": "ClusterFirst",
    "serviceAccountName": "default",
    "serviceAccount": "default",
    "nodeName": "k8s-worker2.localdomain",
    "securityContext": {},
    "schedulerName": "default-scheduler",
    "tolerations": [
      {
        "key": "node.kubernetes.io/not-ready",
        "operator": "Exists",
        "effect": "NoExecute",
        "tolerationSeconds": 300
      },
      {
        "key": "node.kubernetes.io/unreachable",
        "operator": "Exists",
        "effect": "NoExecute",
        "tolerationSeconds": 300
      }
    ],
    "priority": 0,
    "enableServiceLinks": true,
    "preemptionPolicy": "PreemptLowerPriority"
  },
  "status": {
    "phase": "Running",
    "conditions": [
      {
        "type": "Initialized",
        "status": "True",
        "lastProbeTime": null,
        "lastTransitionTime": "2023-05-03T02:32:21Z"
      },
      {
        "type": "Ready",
        "status": "True",
        "lastProbeTime": null,
        "lastTransitionTime": "2023-05-03T02:32:23Z"
      },
      {
        "type": "ContainersReady",
        "status": "True",
        "lastProbeTime": null,
        "lastTransitionTime": "2023-05-03T02:32:23Z"
      },
      {
        "type": "PodScheduled",
        "status": "True",
        "lastProbeTime": null,
        "lastTransitionTime": "2023-05-03T02:32:21Z"
      }
    ],
    "hostIP": "192.168.122.150",
    "podIP": "172.16.219.196",
    "podIPs": [
      {
        "ip": "172.16.219.196"
      }
    ],
    "startTime": "2023-05-03T02:32:21Z",
    "containerStatuses": [
      {
        "name": "kubernetes-bootcamp",
        "state": {
          "running": {
            "startedAt": "2023-05-03T02:32:22Z"
          }
        },
        "lastState": {},
        "ready": true,
        "restartCount": 0,
        "image": "gcr.io/google-samples/kubernetes-bootcamp:v1",
        "imageID": "gcr.io/google-samples/kubernetes-bootcamp@sha256:0d6b8ee63bb57c5f5b6156f446b3bc3b3c143d233037f3a2f00e279c8fcc64af",
        "containerID": "containerd://1a4f1d639ecf276d88686f72df9f2a79edff7b00f62ea76b84147a5faa46e93f",
        "started": true
      }
    ],
    "qosClass": "BestEffort"
  }
}
```

</details>
<br>
デプロイメントを削除

```bash
$ kubectl delete deployment kubernetes-bootcamp
deployment.apps "kubernetes-bootcamp" deleted
$
```

## 3.2.アプリケーションのデプロイ

デプロイメントを生成

```bash
$ kubectl create deployment kubernetes-bootcamp --image=gcr.io/google-samples/kubernetes-bootcamp:v1
```

ポッドの状態を確認

```bash
$ kubectl get pods
NAME                                   READY   STATUS    RESTARTS   AGE
kubernetes-bootcamp-855d5cc575-qn6dl   1/1     Running   0          3m11s
$
```

ポッドのイベントログを確認

```bash
$ kubectl describe pods
```

<details><summary>実行結果</summary>

```bash
$ kubectl describe pods
Name:             kubernetes-bootcamp-855d5cc575-qn6dl
Namespace:        default
Priority:         0
Service Account:  default
Node:             k8s-worker2.localdomain/192.168.122.150
Start Time:       Wed, 03 May 2023 11:32:21 +0900
Labels:           app=kubernetes-bootcamp
                  pod-template-hash=855d5cc575
Annotations:      cni.projectcalico.org/containerID: 83ec94d2c42fecd8e72b84b406c71973e3fefd767ed25b3308b09a06fe64db7c
                  cni.projectcalico.org/podIP: 172.16.219.196/32
                  cni.projectcalico.org/podIPs: 172.16.219.196/32
Status:           Running
IP:               172.16.219.196
IPs:
  IP:           172.16.219.196
Controlled By:  ReplicaSet/kubernetes-bootcamp-855d5cc575
Containers:
  kubernetes-bootcamp:
    Container ID:   containerd://1a4f1d639ecf276d88686f72df9f2a79edff7b00f62ea76b84147a5faa46e93f
    Image:          gcr.io/google-samples/kubernetes-bootcamp:v1
    Image ID:       gcr.io/google-samples/kubernetes-bootcamp@sha256:0d6b8ee63bb57c5f5b6156f446b3bc3b3c143d233037f3a2f00e279c8fcc64af
    Port:           <none>
    Host Port:      <none>
    State:          Running
      Started:      Wed, 03 May 2023 11:32:22 +0900
    Ready:          True
    Restart Count:  0
    Environment:    <none>
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-5zpns (ro)
Conditions:
  Type              Status
  Initialized       True
  Ready             True
  ContainersReady   True
  PodScheduled      True
Volumes:
  kube-api-access-5zpns:
    Type:                    Projected (a volume that contains injected data from multiple sources)
    TokenExpirationSeconds:  3607
    ConfigMapName:           kube-root-ca.crt
    ConfigMapOptional:       <nil>
    DownwardAPI:             true
QoS Class:                   BestEffort
Node-Selectors:              <none>
Tolerations:                 node.kubernetes.io/not-ready:NoExecute op=Exists for 300s
                             node.kubernetes.io/unreachable:NoExecute op=Exists for 300s
Events:
  Type    Reason     Age    From               Message
  ----    ------     ----   ----               -------
  Normal  Scheduled  3m22s  default-scheduler  Successfully assigned default/kubernetes-bootcamp-855d5cc575-qn6dl to k8s-worker2.localdomain
  Normal  Pulled     3m22s  kubelet            Container image "gcr.io/google-samples/kubernetes-bootcamp:v1" already present on machine
  Normal  Created    3m22s  kubelet            Created container kubernetes-bootcamp
  Normal  Started    3m22s  kubelet            Started container kubernetes-bootcamp
$
```

</details>
<br>
プロキシを起動

_別タブ（ターミナル）で実行_

```bash
$ kubectl proxy
```

プロキシ経由でポッドにアクセス

```bash
$ curl http://localhost:8001/api/v1/namespaces/default/pods/$POD_NAME/proxy/
```

_エンドポイント pod から接続拒否のエラー。kube-proxy の設定？_

```bash
$ curl http://localhost:8001/api/v1/namespaces/default/pods/$POD_NAME/proxy/
{
  "kind": "Status",
  "apiVersion": "v1",
  "metadata": {},
  "status": "Failure",
  "message": "error trying to reach service: dial tcp 172.16.219.196:80: connect: connection refused",
  "reason": "ServiceUnavailable",
  "code": 503
}
```

_本来ならこうなる予定_

```bash
$ curl http://localhost:8001/api/v1/namespaces/default/pods/$PO_NAME/proxy/
Hello Kubernetes bootcamp! | Running on: kubernetes-bootcamp-fb5c67579-sgr55 | v=1
```

ポッドのログを確認

```bash
$ kubectl logs $POD_NAME
Kubernetes Bootcamp App Started At: 2023-05-03T02:49:13.942Z | Running On:  kubernetes-bootcamp-855d5cc575-7p9l9

Running On: kubernetes-bootcamp-855d5cc575-7p9l9 | Total Requests: 1 | App Uptime: 601.109 seconds | Log Time: 2023-05-03T02:59:15.051Z
Running On: kubernetes-bootcamp-855d5cc575-7p9l9 | Total Requests: 2 | App Uptime: 805.546 seconds | Log Time: 2023-05-03T03:02:39.488Z
```

ポッドの環境変数を確認

```bash
$ kubectl exec $POD_NAME -- env
PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
HOSTNAME=kubernetes-bootcamp-855d5cc575-7p9l9
NPM_CONFIG_LOGLEVEL=info
NODE_VERSION=6.3.1
KUBERNETES_SERVICE_HOST=10.96.0.1
KUBERNETES_SERVICE_PORT=443
KUBERNETES_SERVICE_PORT_HTTPS=443
KUBERNETES_PORT=tcp://10.96.0.1:443
KUBERNETES_PORT_443_TCP=tcp://10.96.0.1:443
KUBERNETES_PORT_443_TCP_PROTO=tcp
KUBERNETES_PORT_443_TCP_PORT=443
KUBERNETES_PORT_443_TCP_ADDR=10.96.0.1
HOME=/root
```

ポッドに接続し bash を起動

```bash
$ kubectl exec -ti $POD_NAME -- bash
```

<details><summary>実行結果</summary>

```bash
$ kubectl exec -ti $POD_NAME -- bash
root@kubernetes-bootcamp-855d5cc575-7p9l9:/# hostname
kubernetes-bootcamp-855d5cc575-7p9l9
root@kubernetes-bootcamp-855d5cc575-7p9l9:/# pwd
/
root@kubernetes-bootcamp-855d5cc575-7p9l9:/# cat server.js
var http = require('http');
var requests=0;
var podname= process.env.HOSTNAME;
var startTime;
var host;
var handleRequest = function(request, response) {
  response.setHeader('Content-Type', 'text/plain');
  response.writeHead(200);
  response.write("Hello Kubernetes bootcamp! | Running on: ");
  response.write(host);
  response.end(" | v=1\n");
  console.log("Running On:" ,host, "| Total Requests:", ++requests,"| App Uptime:", (new Date() - startTime)/1000 , "seconds", "| Log Time:",new Date());
}
var www = http.createServer(handleRequest);
www.listen(8080,function () {
    startTime = new Date();;
    host = process.env.HOSTNAME;
    console.log ("Kubernetes Bootcamp App Started At:",startTime, "| Running On: " ,host, "\n" );
});
root@kubernetes-bootcamp-855d5cc575-7p9l9:/# curl localhost:8080
Hello Kubernetes bootcamp! | Running on: kubernetes-bootcamp-855d5cc575-7p9l9 | v=1
root@kubernetes-bootcamp-855d5cc575-7p9l9:/# exit
exit
```

</details>
<br>
デプロイメントを削除

```bash
$ kubectl delete deployment kubernetes-bootcamp
deployment.apps "kubernetes-bootcamp" deleted
```

## 3.3.アプリケーションの公開

デプロイメントを生成

```bash
$ kubectl create deployment kubernetes-bootcamp --image=gcr.io/google-samples/kubernetes-bootcamp:v1
```

ポッドの状態を確認

```bash
$ kubectl get pods
NAME                                   READY   STATUS        RESTARTS   AGE
kubernetes-bootcamp-855d5cc575-qn6dl   1/1     Terminating   0          14m
```

サービスの状態を確認（デプロイメント前）

```bash
$ kubectl get services
NAME                  TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)          AGE
kubernetes            ClusterIP   10.96.0.1     <none>        443/TCP          27h
```

ノードポートサービスを生成

```bash
$ kubectl expose deployment/kubernetes-bootcamp --type="NodePort" --port 8080
service/kubernetes-bootcamp exposed
```

サービスの状態を確認（デプロイメント後）

```bash
$ kubectl get services
NAME                  TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)          AGE
kubernetes            ClusterIP   10.96.0.1     <none>        443/TCP          27h
kubernetes-bootcamp   NodePort    10.97.92.98   <none>        8080:31053/TCP   11s
```

サービスの定義を確認

```bash
$ kubectl describe services/kubernetes-bootcamp
Name:                     kubernetes-bootcamp
Namespace:                default
Labels:                   app=kubernetes-bootcamp
Annotations:              <none>
Selector:                 app=kubernetes-bootcamp
Type:                     NodePort
IP Family Policy:         SingleStack
IP Families:              IPv4
IP:                       10.97.92.98
IPs:                      10.97.92.98
Port:                     <unset>  8080/TCP
TargetPort:               8080/TCP
NodePort:                 <unset>  31053/TCP
Endpoints:                172.16.219.197:8080
Session Affinity:         None
External Traffic Policy:  Cluster
Events:                   <none>
```

ノードのポート番号を環境変数に設定

```bash
$ export NODE_PORT=$(kubectl get services/kubernetes-bootcamp -o go-template='{{(index .spec.ports 0).nodePort}}')
$ echo NODE_PORT=$NODE_PORT
NODE_PORT=31053
```

ポッドにノードポート経由でアクセス

```bash
$ curl 192.168.122.155:31053
Hello Kubernetes bootcamp! | Running on: kubernetes-bootcamp-855d5cc575-7p9l9 | v=1
```

デプロイメントのイベントログを確認（ポッドのラベル設定前）

```bash
$ kubectl describe deployment
```

<details><summary>実行結果</summary>

```bash
$ kubectl describe deployment
Name:                   kubernetes-bootcamp
Namespace:              default
CreationTimestamp:      Wed, 03 May 2023 11:49:12 +0900
Labels:                 app=kubernetes-bootcamp
Annotations:            deployment.kubernetes.io/revision: 1
Selector:               app=kubernetes-bootcamp
Replicas:               1 desired | 1 updated | 1 total | 1 available | 0 unavailable
StrategyType:           RollingUpdate
MinReadySeconds:        0
RollingUpdateStrategy:  25% max unavailable, 25% max surge
Pod Template:
  Labels:  app=kubernetes-bootcamp
  Containers:
   kubernetes-bootcamp:
    Image:        gcr.io/google-samples/kubernetes-bootcamp:v1
    Port:         <none>
    Host Port:    <none>
    Environment:  <none>
    Mounts:       <none>
  Volumes:        <none>
Conditions:
  Type           Status  Reason
  ----           ------  ------
  Available      True    MinimumReplicasAvailable
  Progressing    True    NewReplicaSetAvailable
OldReplicaSets:  <none>
NewReplicaSet:   kubernetes-bootcamp-855d5cc575 (1/1 replicas created)
Events:
  Type    Reason             Age   From                   Message
  ----    ------             ----  ----                   -------
  Normal  ScalingReplicaSet  10m   deployment-controller  Scaled up replica set kubernetes-bootcamp-855d5cc575 to 1
```

</details>
<br>
ポッドの状態を確認（ポッド指定）

```bash
$ kubectl get pods -l app=kubernetes-bootcamp
NAME                                   READY   STATUS    RESTARTS   AGE
kubernetes-bootcamp-855d5cc575-7p9l9   1/1     Running   0          10m
```

サービスの状態を確認（ポッド指定）

```bash
$ kubectl get services -l app=kubernetes-bootcamp
NAME                  TYPE       CLUSTER-IP    EXTERNAL-IP   PORT(S)          AGE
kubernetes-bootcamp   NodePort   10.97.92.98   <none>        8080:31053/TCP   10m
```

ポッド名を取得し環境変数に設定

```bash
$ export POD_NAME=$(kubectl get pods -o go-template --template '{{range .items}}{{.metadata.name}}{{"\n"}}{{end}}')
$ echo Name of the Pod: $POD_NAME
Name of the Pod: kubernetes-bootcamp-855d5cc575-7p9l9
```

ポッドにラベルを設定

```bash
$ kubectl label pods $POD_NAME version=v1
pod/kubernetes-bootcamp-855d5cc575-7p9l9 labeled
```

デプロイメントのイベントログを確認（ポッドのラベル設定後）

```bash
$ kubectl describe pods $POD_NAME
```

<details><summary>実行結果</summary>

```bash
$ kubectl describe pods $POD_NAME
Name:             kubernetes-bootcamp-855d5cc575-7p9l9
Namespace:        default
Priority:         0
Service Account:  default
Node:             k8s-worker2.localdomain/192.168.122.150
Start Time:       Wed, 03 May 2023 11:49:13 +0900
Labels:           app=kubernetes-bootcamp
                  pod-template-hash=855d5cc575
                  version=v1
Annotations:      cni.projectcalico.org/containerID: b9699c14d13e254e7514ca59faf001cf6df92e6362fec7d85bc238f05b640fb6
                  cni.projectcalico.org/podIP: 172.16.219.197/32
                  cni.projectcalico.org/podIPs: 172.16.219.197/32
Status:           Running
IP:               172.16.219.197
IPs:
  IP:           172.16.219.197
Controlled By:  ReplicaSet/kubernetes-bootcamp-855d5cc575
Containers:
  kubernetes-bootcamp:
    Container ID:   containerd://5a50941a5ada22da145485aead7fb96416f7bf0d8551f776e74a5726ca576528
    Image:          gcr.io/google-samples/kubernetes-bootcamp:v1
    Image ID:       gcr.io/google-samples/kubernetes-bootcamp@sha256:0d6b8ee63bb57c5f5b6156f446b3bc3b3c143d233037f3a2f00e279c8fcc64af
    Port:           <none>
    Host Port:      <none>
    State:          Running
      Started:      Wed, 03 May 2023 11:49:13 +0900
    Ready:          True
    Restart Count:  0
    Environment:    <none>
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-s7pkv (ro)
Conditions:
  Type              Status
  Initialized       True
  Ready             True
  ContainersReady   True
  PodScheduled      True
Volumes:
  kube-api-access-s7pkv:
    Type:                    Projected (a volume that contains injected data from multiple sources)
    TokenExpirationSeconds:  3607
    ConfigMapName:           kube-root-ca.crt
    ConfigMapOptional:       <nil>
    DownwardAPI:             true
QoS Class:                   BestEffort
Node-Selectors:              <none>
Tolerations:                 node.kubernetes.io/not-ready:NoExecute op=Exists for 300s
                             node.kubernetes.io/unreachable:NoExecute op=Exists for 300s
Events:
  Type    Reason     Age   From               Message
  ----    ------     ----  ----               -------
  Normal  Scheduled  12m   default-scheduler  Successfully assigned default/kubernetes-bootcamp-855d5cc575-7p9l9 to k8s-worker2.localdomain
  Normal  Pulled     12m   kubelet            Container image "gcr.io/google-samples/kubernetes-bootcamp:v1" already present on machine
  Normal  Created    12m   kubelet            Created container kubernetes-bootcamp
  Normal  Started    12m   kubelet            Started container kubernetes-bootcamp
```

</details>
<br>
ラベル設定前後の差分

```diff_bash
Labels:           app=kubernetes-bootcamp
+                  pod-template-hash=855d5cc575
+                  version=v1
```

ポッドの状態を確認（ラベル指定）

```bash
$ kubectl get pods -l version=v1
NAME                                   READY   STATUS    RESTARTS   AGE
kubernetes-bootcamp-855d5cc575-7p9l9   1/1     Running   0          12m
```

サービスを削除

```bash
$ kubectl delete service -l app=kubernetes-bootcamp
service "kubernetes-bootcamp" deleted
```

サービスの状態を確認

```bash
$ kubectl get services
NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE
kubernetes   ClusterIP   10.96.0.1    <none>        443/TCP   27h
```

サービス削除後のポッドへのアクセス

```bash
$ curl 192.168.122.155:31053
curl: (7) Failed to connect to 192.168.122.155 port 31053: 接続を拒否されました
```

ポッドに接続し curl でアクセス

```bash
$ kubectl exec -ti $POD_NAME -- curl localhost:8080
Hello Kubernetes bootcamp! | Running on: kubernetes-bootcamp-855d5cc575-7p9l9 | v=1
```

デプロイメントを削除

```bash
$ kubectl delete deployment kubernetes-bootcamp
deployment.apps "kubernetes-bootcamp" deleted
```

## 3.4.アプリケーションのスケーリング

デプロイメントを生成

```bash
$ kubectl create deployment kubernetes-bootcamp --image=gcr.io/google-samples/kubernetes-bootcamp:v1
```

ノードポートサービスを生成

```bash
$ kubectl expose deployment/kubernetes-bootcamp --type="NodePort" --port 8080
```

デプロイメントの確認

```bash
$ kubectl get deployments
NAME                  READY   UP-TO-DATE   AVAILABLE   AGE
kubernetes-bootcamp   1/1     1            1           7m26s
```

デプロイメントのレプリカセットを確認

```bash
$ kubectl get rs
NAME                             DESIRED   CURRENT   READY   AGE
kubernetes-bootcamp-855d5cc575   1         1         1       8m45s
```

スケールを設定（レプリカ数=4）

```bash
$ kubectl scale deployments/kubernetes-bootcamp --replicas=4
deployment.apps/kubernetes-bootcamp scaled
```

デプロイメントの確認

```bash
$ kubectl get deployments
NAME                  READY   UP-TO-DATE   AVAILABLE   AGE
kubernetes-bootcamp   4/4     4            4           12m
```

ポッドを確認

```bash
$ kubectl get pods -o wide
NAME                                   READY   STATUS    RESTARTS   AGE     IP               NODE                      NOMINATED NODE   READINESS GATES
kubernetes-bootcamp-855d5cc575-5xhwf   1/1     Running   0          13m     172.16.219.199   k8s-worker2.localdomain   <none>           <none>
kubernetes-bootcamp-855d5cc575-85x9b   1/1     Running   0          2m36s   172.16.55.70     k8s-worker1.localdomain   <none>           <none>
kubernetes-bootcamp-855d5cc575-gb5dz   1/1     Running   0          2m36s   172.16.55.69     k8s-worker1.localdomain   <none>           <none>
kubernetes-bootcamp-855d5cc575-wzlpv   1/1     Running   0          2m36s   172.16.219.200   k8s-worker2.localdomain   <none>           <none>
```

デプロイメントのイベントログを確認

```bash
$ kubectl describe deployments/kubernetes-bootcamp
```

<details><summary>実行結果</summary>

```bash
$ kubectl describe deployments/kubernetes-bootcamp
Name:                   kubernetes-bootcamp
Namespace:              default
CreationTimestamp:      Thu, 04 May 2023 14:39:47 +0900
Labels:                 app=kubernetes-bootcamp
Annotations:            deployment.kubernetes.io/revision: 1
Selector:               app=kubernetes-bootcamp
Replicas:               4 desired | 4 updated | 4 total | 4 available | 0 unavailable
StrategyType:           RollingUpdate
MinReadySeconds:        0
RollingUpdateStrategy:  25% max unavailable, 25% max surge
Pod Template:
  Labels:  app=kubernetes-bootcamp
  Containers:
   kubernetes-bootcamp:
    Image:        gcr.io/google-samples/kubernetes-bootcamp:v1
    Port:         <none>
    Host Port:    <none>
    Environment:  <none>
    Mounts:       <none>
  Volumes:        <none>
Conditions:
  Type           Status  Reason
  ----           ------  ------
  Progressing    True    NewReplicaSetAvailable
  Available      True    MinimumReplicasAvailable
OldReplicaSets:  <none>
NewReplicaSet:   kubernetes-bootcamp-855d5cc575 (4/4 replicas created)
Events:
  Type    Reason             Age    From                   Message
  ----    ------             ----   ----                   -------
  Normal  ScalingReplicaSet  4m15s  deployment-controller  Scaled up replica set kubernetes-bootcamp-855d5cc575 to 1
  Normal  ScalingReplicaSet  37s    deployment-controller  Scaled up replica set kubernetes-bootcamp-855d5cc575 to 4 from 1
```

</details>
<br>
ノードのポート番号を取得し環境変数に設定

```bash
$ export NODE_PORT=$(kubectl get services/kubernetes-bootcamp -o go-template='{{(index .spec.ports 0).nodePort}}')
[bravog@bravo55 ~]$ echo $NODE_PORT
32404
```

ノードポート経由でポッドにアクセス

```bash
$ curl 192.168.122.155:$NODE_PORT
Hello Kubernetes bootcamp! | Running on: kubernetes-bootcamp-855d5cc575-drbds | v=1
```

スケールを変更（レプリカ数=2）

```bash
$ kubectl scale deployments/kubernetes-bootcamp --replicas=2
deployment.apps/kubernetes-bootcamp scaled
```

デプロイメントを確認

```bash
$ kubectl get deployments
NAME                  READY   UP-TO-DATE   AVAILABLE   AGE
kubernetes-bootcamp   2/2     2            2           9m56s
```

ポッドの状態を確認

```bash
$ kubectl get pods -o wide
NAME                                   READY   STATUS    RESTARTS   AGE     IP               NODE                      NOMINATED NODE   READINESS GATES
kubernetes-bootcamp-855d5cc575-4fqb6   1/1     Running   0          11m     172.16.219.201   k8s-worker2.localdomain   <none>           <none>
kubernetes-bootcamp-855d5cc575-jm2hm   1/1     Running   0          7m29s   172.16.55.72     k8s-worker1.localdomain   <none>           <none>
```

デプロイメントを削除

```bash
$ kubectl delete deployment kubernetes-bootcamp
```

ノードポートサービスを削除

```bash
$ kubectl delete service kubernetes-bootcamp
```

## 3.5.アプリケーションのアップデート

デプロイメントを生成

```bash
$ kubectl create deployment kubernetes-bootcamp --image=gcr.io/google-samples/kubernetes-bootcamp:v1
```

ノードポートサービスを生成

```bash
$ kubectl expose deployment/kubernetes-bootcamp --type="NodePort" --port 8080
```

スケールを変更（レプリカ数=4）

```bash
$ kubectl scale deployments/kubernetes-bootcamp --replicas=4
```

デプロイメントを確認

```bash
$ kubectl get deployments
NAME                  READY   UP-TO-DATE   AVAILABLE   AGE
kubernetes-bootcamp   4/4     4            4           2m21s
```

ポッドの状態を確認

```bash
$ kubectl get pods
NAME                                   READY   STATUS    RESTARTS   AGE
kubernetes-bootcamp-855d5cc575-ktsq8   1/1     Running   0          105s
kubernetes-bootcamp-855d5cc575-tfz6p   1/1     Running   0          105s
kubernetes-bootcamp-855d5cc575-wqb7g   1/1     Running   0          105s
kubernetes-bootcamp-855d5cc575-wxnpc   1/1     Running   0          3m28s
```

ポッドのイベントログを確認

```bash
$ kubectl describe pods
```

<details><summary>実行結果</summary>

```bash
$ kubectl describe pods
Name:             kubernetes-bootcamp-855d5cc575-ktsq8
Namespace:        default
Priority:         0
Service Account:  default
Node:             k8s-worker1.localdomain/192.168.122.193
Start Time:       Thu, 04 May 2023 15:04:15 +0900
Labels:           app=kubernetes-bootcamp
                  pod-template-hash=855d5cc575
Annotations:      cni.projectcalico.org/containerID: a4f523d593da253ba2ba92fb4637168c9a65f6624c46a9a3f96fbfa5188c4626
                  cni.projectcalico.org/podIP: 172.16.55.74/32
                  cni.projectcalico.org/podIPs: 172.16.55.74/32
Status:           Running
IP:               172.16.55.74
IPs:
  IP:           172.16.55.74
Controlled By:  ReplicaSet/kubernetes-bootcamp-855d5cc575
Containers:
  kubernetes-bootcamp:
    Container ID:   containerd://0917b4748082ec330e9fbd6b4515c77dab76d54bc35da53f508ca6a34a593e9c
    Image:          gcr.io/google-samples/kubernetes-bootcamp:v1
    Image ID:       gcr.io/google-samples/kubernetes-bootcamp@sha256:0d6b8ee63bb57c5f5b6156f446b3bc3b3c143d233037f3a2f00e279c8fcc64af
    Port:           <none>
    Host Port:      <none>
    State:          Running
      Started:      Thu, 04 May 2023 15:04:18 +0900
    Ready:          True
    Restart Count:  0
    Environment:    <none>
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-pv5pj (ro)
Conditions:
  Type              Status
  Initialized       True
  Ready             True
  ContainersReady   True
  PodScheduled      True
Volumes:
  kube-api-access-pv5pj:
    Type:                    Projected (a volume that contains injected data from multiple sources)
    TokenExpirationSeconds:  3607
    ConfigMapName:           kube-root-ca.crt
    ConfigMapOptional:       <nil>
    DownwardAPI:             true
QoS Class:                   BestEffort
Node-Selectors:              <none>
Tolerations:                 node.kubernetes.io/not-ready:NoExecute op=Exists for 300s
                             node.kubernetes.io/unreachable:NoExecute op=Exists for 300s
Events:
  Type     Reason       Age    From               Message
  ----     ------       ----   ----               -------
  Normal   Scheduled    2m56s  default-scheduler  Successfully assigned default/kubernetes-bootcamp-855d5cc575-ktsq8 to k8s-worker1.localdomain
  Warning  FailedMount  2m56s  kubelet            MountVolume.SetUp failed for volume "kube-api-access-pv5pj" : failed to sync configmap cache: timed out waiting for the condition
  Normal   Pulled       2m55s  kubelet            Container image "gcr.io/google-samples/kubernetes-bootcamp:v1" already present on machine
  Normal   Created      2m55s  kubelet            Created container kubernetes-bootcamp
  Normal   Started      2m54s  kubelet            Started container kubernetes-bootcamp


Name:             kubernetes-bootcamp-855d5cc575-tfz6p
Namespace:        default
Priority:         0
Service Account:  default
Node:             k8s-worker2.localdomain/192.168.122.150
Start Time:       Thu, 04 May 2023 15:04:15 +0900
Labels:           app=kubernetes-bootcamp
                  pod-template-hash=855d5cc575
Annotations:      cni.projectcalico.org/containerID: aeb6e7e7787b8c254b68196369329d7936419e47c06f5ed41e85126c8663e813
                  cni.projectcalico.org/podIP: 172.16.219.204/32
                  cni.projectcalico.org/podIPs: 172.16.219.204/32
Status:           Running
IP:               172.16.219.204
IPs:
  IP:           172.16.219.204
Controlled By:  ReplicaSet/kubernetes-bootcamp-855d5cc575
Containers:
  kubernetes-bootcamp:
    Container ID:   containerd://55e925bcd16d400273628cd7edde1e52d3fc34421fcfef63b56efa2ba9276ade
    Image:          gcr.io/google-samples/kubernetes-bootcamp:v1
    Image ID:       gcr.io/google-samples/kubernetes-bootcamp@sha256:0d6b8ee63bb57c5f5b6156f446b3bc3b3c143d233037f3a2f00e279c8fcc64af
    Port:           <none>
    Host Port:      <none>
    State:          Running
      Started:      Thu, 04 May 2023 15:04:16 +0900
    Ready:          True
    Restart Count:  0
    Environment:    <none>
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-cnmmd (ro)
Conditions:
  Type              Status
  Initialized       True
  Ready             True
  ContainersReady   True
  PodScheduled      True
Volumes:
  kube-api-access-cnmmd:
    Type:                    Projected (a volume that contains injected data from multiple sources)
    TokenExpirationSeconds:  3607
    ConfigMapName:           kube-root-ca.crt
    ConfigMapOptional:       <nil>
    DownwardAPI:             true
QoS Class:                   BestEffort
Node-Selectors:              <none>
Tolerations:                 node.kubernetes.io/not-ready:NoExecute op=Exists for 300s
                             node.kubernetes.io/unreachable:NoExecute op=Exists for 300s
Events:
  Type    Reason     Age    From               Message
  ----    ------     ----   ----               -------
  Normal  Scheduled  2m56s  default-scheduler  Successfully assigned default/kubernetes-bootcamp-855d5cc575-tfz6p to k8s-worker2.localdomain
  Normal  Pulled     2m56s  kubelet            Container image "gcr.io/google-samples/kubernetes-bootcamp:v1" already present on machine
  Normal  Created    2m56s  kubelet            Created container kubernetes-bootcamp
  Normal  Started    2m56s  kubelet            Started container kubernetes-bootcamp


Name:             kubernetes-bootcamp-855d5cc575-wqb7g
Namespace:        default
Priority:         0
Service Account:  default
Node:             k8s-worker1.localdomain/192.168.122.193
Start Time:       Thu, 04 May 2023 15:04:15 +0900
Labels:           app=kubernetes-bootcamp
                  pod-template-hash=855d5cc575
Annotations:      cni.projectcalico.org/containerID: f1b3b4e05d195c334f4d91eace8610e4b46cfa5d55ab88c89752c64daf2543d0
                  cni.projectcalico.org/podIP: 172.16.55.73/32
                  cni.projectcalico.org/podIPs: 172.16.55.73/32
Status:           Running
IP:               172.16.55.73
IPs:
  IP:           172.16.55.73
Controlled By:  ReplicaSet/kubernetes-bootcamp-855d5cc575
Containers:
  kubernetes-bootcamp:
    Container ID:   containerd://9417e559cdf08dc9db3b6e58d07434de972112ac05c43b26c8fe75274196d24d
    Image:          gcr.io/google-samples/kubernetes-bootcamp:v1
    Image ID:       gcr.io/google-samples/kubernetes-bootcamp@sha256:0d6b8ee63bb57c5f5b6156f446b3bc3b3c143d233037f3a2f00e279c8fcc64af
    Port:           <none>
    Host Port:      <none>
    State:          Running
      Started:      Thu, 04 May 2023 15:04:18 +0900
    Ready:          True
    Restart Count:  0
    Environment:    <none>
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-n85jf (ro)
Conditions:
  Type              Status
  Initialized       True
  Ready             True
  ContainersReady   True
  PodScheduled      True
Volumes:
  kube-api-access-n85jf:
    Type:                    Projected (a volume that contains injected data from multiple sources)
    TokenExpirationSeconds:  3607
    ConfigMapName:           kube-root-ca.crt
    ConfigMapOptional:       <nil>
    DownwardAPI:             true
QoS Class:                   BestEffort
Node-Selectors:              <none>
Tolerations:                 node.kubernetes.io/not-ready:NoExecute op=Exists for 300s
                             node.kubernetes.io/unreachable:NoExecute op=Exists for 300s
Events:
  Type     Reason       Age    From               Message
  ----     ------       ----   ----               -------
  Normal   Scheduled    2m56s  default-scheduler  Successfully assigned default/kubernetes-bootcamp-855d5cc575-wqb7g to k8s-worker1.localdomain
  Warning  FailedMount  2m56s  kubelet            MountVolume.SetUp failed for volume "kube-api-access-n85jf" : failed to sync configmap cache: timed out waiting for the condition
  Normal   Pulled       2m55s  kubelet            Container image "gcr.io/google-samples/kubernetes-bootcamp:v1" already present on machine
  Normal   Created      2m55s  kubelet            Created container kubernetes-bootcamp
  Normal   Started      2m54s  kubelet            Started container kubernetes-bootcamp


Name:             kubernetes-bootcamp-855d5cc575-wxnpc
Namespace:        default
Priority:         0
Service Account:  default
Node:             k8s-worker2.localdomain/192.168.122.150
Start Time:       Thu, 04 May 2023 15:02:32 +0900
Labels:           app=kubernetes-bootcamp
                  pod-template-hash=855d5cc575
Annotations:      cni.projectcalico.org/containerID: 82143cf94eb79a031a028c6b92c458ad9d95a2140ada787a643dea8d6f86897a
                  cni.projectcalico.org/podIP: 172.16.219.203/32
                  cni.projectcalico.org/podIPs: 172.16.219.203/32
Status:           Running
IP:               172.16.219.203
IPs:
  IP:           172.16.219.203
Controlled By:  ReplicaSet/kubernetes-bootcamp-855d5cc575
Containers:
  kubernetes-bootcamp:
    Container ID:   containerd://2acab8b42e7d0f854b885d2c4295171faedf0d6304c9903b7cba972374449536
    Image:          gcr.io/google-samples/kubernetes-bootcamp:v1
    Image ID:       gcr.io/google-samples/kubernetes-bootcamp@sha256:0d6b8ee63bb57c5f5b6156f446b3bc3b3c143d233037f3a2f00e279c8fcc64af
    Port:           <none>
    Host Port:      <none>
    State:          Running
      Started:      Thu, 04 May 2023 15:02:33 +0900
    Ready:          True
    Restart Count:  0
    Environment:    <none>
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-7hpgh (ro)
Conditions:
  Type              Status
  Initialized       True
  Ready             True
  ContainersReady   True
  PodScheduled      True
Volumes:
  kube-api-access-7hpgh:
    Type:                    Projected (a volume that contains injected data from multiple sources)
    TokenExpirationSeconds:  3607
    ConfigMapName:           kube-root-ca.crt
    ConfigMapOptional:       <nil>
    DownwardAPI:             true
QoS Class:                   BestEffort
Node-Selectors:              <none>
Tolerations:                 node.kubernetes.io/not-ready:NoExecute op=Exists for 300s
                             node.kubernetes.io/unreachable:NoExecute op=Exists for 300s
Events:
  Type    Reason     Age    From               Message
  ----    ------     ----   ----               -------
  Normal  Scheduled  4m39s  default-scheduler  Successfully assigned default/kubernetes-bootcamp-855d5cc575-wxnpc to k8s-worker2.localdomain
  Normal  Pulled     4m39s  kubelet            Container image "gcr.io/google-samples/kubernetes-bootcamp:v1" already present on machine
  Normal  Created    4m39s  kubelet            Created container kubernetes-bootcamp
  Normal  Started    4m39s  kubelet            Started container kubernetes-bootcamp
```

</details>
<br>
ポッドで実行するイメージを v1 から v2 に変更

```bash
$ kubectl set image deployments/kubernetes-bootcamp kubernetes-bootcamp=jocatalin/kubernetes-bootcamp:v2
deployment.apps/kubernetes-bootcamp image updated
```

ポッドの状態を確認

```bash
$ kubectl get pods
NAME                                   READY   STATUS    RESTARTS   AGE
kubernetes-bootcamp-69b6f9fbb9-8g9jp   1/1     Running   0          94s
kubernetes-bootcamp-69b6f9fbb9-p4xvf   1/1     Running   0          95s
kubernetes-bootcamp-69b6f9fbb9-prszg   1/1     Running   0          89s
kubernetes-bootcamp-69b6f9fbb9-s72bb   1/1     Running   0          88s
```

_→ ポッド名が変わっている_

ノードポートサービスの状態を確認

```bash
$ kubectl describe services/kubernetes-bootcamp
Name:                     kubernetes-bootcamp
Namespace:                default
Labels:                   app=kubernetes-bootcamp
Annotations:              <none>
Selector:                 app=kubernetes-bootcamp
Type:                     NodePort
IP Family Policy:         SingleStack
IP Families:              IPv4
IP:                       10.100.143.145
IPs:                      10.100.143.145
Port:                     <unset>  8080/TCP
TargetPort:               8080/TCP
NodePort:                 <unset>  31793/TCP
Endpoints:                172.16.219.205:8080,172.16.219.206:8080,172.16.55.75:8080 + 1 more...
Session Affinity:         None
External Traffic Policy:  Cluster
Events:                   <none>
```

ノードポートのポート番号を取得し環境変数に設定

```bash
$ export NODE_PORT=$(kubectl get services/kubernetes-bootcamp -o go-template='{{(index .spec.ports 0).nodePort}}')
$ echo $NODE_PORT
31793
```

ノードポート経由でポッドにアクセス

```bash
$ curl 192.168.122.155:$NODE_PORT
Hello Kubernetes bootcamp! | Running on: kubernetes-bootcamp-69b6f9fbb9-prszg | v=2
```

イメージをロールアウト（アプリケーションを更新）

```bash
$ kubectl rollout status deployments/kubernetes-bootcamp
deployment "kubernetes-bootcamp" successfully rolled out
```

ポッドのイベントログを確認

```bash
$ kubectl describe pods
```

<details><summary>実行結果</summary>

```bash
$ kubectl describe pods
Name:             kubernetes-bootcamp-69b6f9fbb9-8g9jp
Namespace:        default
Priority:         0
Service Account:  default
Node:             k8s-worker1.localdomain/192.168.122.193
Start Time:       Thu, 04 May 2023 15:10:23 +0900
Labels:           app=kubernetes-bootcamp
                  pod-template-hash=69b6f9fbb9
Annotations:      cni.projectcalico.org/containerID: f6209c1264d9c794d0ec0995d45206f202771458612589ad8ffb3d518f3c35e9
                  cni.projectcalico.org/podIP: 172.16.55.75/32
                  cni.projectcalico.org/podIPs: 172.16.55.75/32
Status:           Running
IP:               172.16.55.75
IPs:
  IP:           172.16.55.75
Controlled By:  ReplicaSet/kubernetes-bootcamp-69b6f9fbb9
Containers:
  kubernetes-bootcamp:
    Container ID:   containerd://f3f23effa036a42830b23e5d819d391d4a9db34cd25ab632db9c8e5f90ba9f26
    Image:          jocatalin/kubernetes-bootcamp:v2
    Image ID:       docker.io/jocatalin/kubernetes-bootcamp@sha256:fb1a3ced00cecfc1f83f18ab5cd14199e30adc1b49aa4244f5d65ad3f5feb2a5
    Port:           <none>
    Host Port:      <none>
    State:          Running
      Started:      Thu, 04 May 2023 15:10:28 +0900
    Ready:          True
    Restart Count:  0
    Environment:    <none>
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-mskkv (ro)
Conditions:
  Type              Status
  Initialized       True
  Ready             True
  ContainersReady   True
  PodScheduled      True
Volumes:
  kube-api-access-mskkv:
    Type:                    Projected (a volume that contains injected data from multiple sources)
    TokenExpirationSeconds:  3607
    ConfigMapName:           kube-root-ca.crt
    ConfigMapOptional:       <nil>
    DownwardAPI:             true
QoS Class:                   BestEffort
Node-Selectors:              <none>
Tolerations:                 node.kubernetes.io/not-ready:NoExecute op=Exists for 300s
                             node.kubernetes.io/unreachable:NoExecute op=Exists for 300s
Events:
  Type    Reason     Age    From               Message
  ----    ------     ----   ----               -------
  Normal  Scheduled  9m36s  default-scheduler  Successfully assigned default/kubernetes-bootcamp-69b6f9fbb9-8g9jp to k8s-worker1.localdomain
  Normal  Pulling    9m36s  kubelet            Pulling image "jocatalin/kubernetes-bootcamp:v2"
  Normal  Pulled     9m31s  kubelet            Successfully pulled image "jocatalin/kubernetes-bootcamp:v2" in 4.644163467s (4.644169821s including waiting)
  Normal  Created    9m31s  kubelet            Created container kubernetes-bootcamp
  Normal  Started    9m31s  kubelet            Started container kubernetes-bootcamp


Name:             kubernetes-bootcamp-69b6f9fbb9-p4xvf
Namespace:        default
Priority:         0
Service Account:  default
Node:             k8s-worker2.localdomain/192.168.122.150
Start Time:       Thu, 04 May 2023 15:10:22 +0900
Labels:           app=kubernetes-bootcamp
                  pod-template-hash=69b6f9fbb9
Annotations:      cni.projectcalico.org/containerID: 9c024d686c9f738f7e43c1b7cb37a25ff3722e6c1c785d651ccec32dfb2b19c1
                  cni.projectcalico.org/podIP: 172.16.219.205/32
                  cni.projectcalico.org/podIPs: 172.16.219.205/32
Status:           Running
IP:               172.16.219.205
IPs:
  IP:           172.16.219.205
Controlled By:  ReplicaSet/kubernetes-bootcamp-69b6f9fbb9
Containers:
  kubernetes-bootcamp:
    Container ID:   containerd://56cfe8176a53ff4e4c0624a2c742d0f704a3161f8366eff2dd713a60d49a2d91
    Image:          jocatalin/kubernetes-bootcamp:v2
    Image ID:       docker.io/jocatalin/kubernetes-bootcamp@sha256:fb1a3ced00cecfc1f83f18ab5cd14199e30adc1b49aa4244f5d65ad3f5feb2a5
    Port:           <none>
    Host Port:      <none>
    State:          Running
      Started:      Thu, 04 May 2023 15:10:28 +0900
    Ready:          True
    Restart Count:  0
    Environment:    <none>
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-gvch8 (ro)
Conditions:
  Type              Status
  Initialized       True
  Ready             True
  ContainersReady   True
  PodScheduled      True
Volumes:
  kube-api-access-gvch8:
    Type:                    Projected (a volume that contains injected data from multiple sources)
    TokenExpirationSeconds:  3607
    ConfigMapName:           kube-root-ca.crt
    ConfigMapOptional:       <nil>
    DownwardAPI:             true
QoS Class:                   BestEffort
Node-Selectors:              <none>
Tolerations:                 node.kubernetes.io/not-ready:NoExecute op=Exists for 300s
                             node.kubernetes.io/unreachable:NoExecute op=Exists for 300s
Events:
  Type    Reason     Age    From               Message
  ----    ------     ----   ----               -------
  Normal  Scheduled  9m36s  default-scheduler  Successfully assigned default/kubernetes-bootcamp-69b6f9fbb9-p4xvf to k8s-worker2.localdomain
  Normal  Pulling    9m36s  kubelet            Pulling image "jocatalin/kubernetes-bootcamp:v2"
  Normal  Pulled     9m31s  kubelet            Successfully pulled image "jocatalin/kubernetes-bootcamp:v2" in 4.737592103s (4.737597887s including waiting)
  Normal  Created    9m31s  kubelet            Created container kubernetes-bootcamp
  Normal  Started    9m31s  kubelet            Started container kubernetes-bootcamp


Name:             kubernetes-bootcamp-69b6f9fbb9-prszg
Namespace:        default
Priority:         0
Service Account:  default
Node:             k8s-worker2.localdomain/192.168.122.150
Start Time:       Thu, 04 May 2023 15:10:29 +0900
Labels:           app=kubernetes-bootcamp
                  pod-template-hash=69b6f9fbb9
Annotations:      cni.projectcalico.org/containerID: 5aafb6a17c463e08a7af2b74513c4b88ba66de0fe653948b853ed481ef821339
                  cni.projectcalico.org/podIP: 172.16.219.206/32
                  cni.projectcalico.org/podIPs: 172.16.219.206/32
Status:           Running
IP:               172.16.219.206
IPs:
  IP:           172.16.219.206
Controlled By:  ReplicaSet/kubernetes-bootcamp-69b6f9fbb9
Containers:
  kubernetes-bootcamp:
    Container ID:   containerd://045beaa86f73c5657cad679cddbbbcea7a2cbbcf843d67fa7bc4978a117ef658
    Image:          jocatalin/kubernetes-bootcamp:v2
    Image ID:       docker.io/jocatalin/kubernetes-bootcamp@sha256:fb1a3ced00cecfc1f83f18ab5cd14199e30adc1b49aa4244f5d65ad3f5feb2a5
    Port:           <none>
    Host Port:      <none>
    State:          Running
      Started:      Thu, 04 May 2023 15:10:29 +0900
    Ready:          True
    Restart Count:  0
    Environment:    <none>
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-rmvdm (ro)
Conditions:
  Type              Status
  Initialized       True
  Ready             True
  ContainersReady   True
  PodScheduled      True
Volumes:
  kube-api-access-rmvdm:
    Type:                    Projected (a volume that contains injected data from multiple sources)
    TokenExpirationSeconds:  3607
    ConfigMapName:           kube-root-ca.crt
    ConfigMapOptional:       <nil>
    DownwardAPI:             true
QoS Class:                   BestEffort
Node-Selectors:              <none>
Tolerations:                 node.kubernetes.io/not-ready:NoExecute op=Exists for 300s
                             node.kubernetes.io/unreachable:NoExecute op=Exists for 300s
Events:
  Type    Reason     Age    From               Message
  ----    ------     ----   ----               -------
  Normal  Scheduled  9m30s  default-scheduler  Successfully assigned default/kubernetes-bootcamp-69b6f9fbb9-prszg to k8s-worker2.localdomain
  Normal  Pulled     9m30s  kubelet            Container image "jocatalin/kubernetes-bootcamp:v2" already present on machine
  Normal  Created    9m30s  kubelet            Created container kubernetes-bootcamp
  Normal  Started    9m30s  kubelet            Started container kubernetes-bootcamp


Name:             kubernetes-bootcamp-69b6f9fbb9-s72bb
Namespace:        default
Priority:         0
Service Account:  default
Node:             k8s-worker1.localdomain/192.168.122.193
Start Time:       Thu, 04 May 2023 15:10:29 +0900
Labels:           app=kubernetes-bootcamp
                  pod-template-hash=69b6f9fbb9
Annotations:      cni.projectcalico.org/containerID: 76563663b47e61181d9a2607d2acc445278b205fad78052ec3d52b27a59d0f21
                  cni.projectcalico.org/podIP: 172.16.55.76/32
                  cni.projectcalico.org/podIPs: 172.16.55.76/32
Status:           Running
IP:               172.16.55.76
IPs:
  IP:           172.16.55.76
Controlled By:  ReplicaSet/kubernetes-bootcamp-69b6f9fbb9
Containers:
  kubernetes-bootcamp:
    Container ID:   containerd://80a49a40be9a7735030e37824b3cf973056f9da1d49fa716e9c5e37e2fa80842
    Image:          jocatalin/kubernetes-bootcamp:v2
    Image ID:       docker.io/jocatalin/kubernetes-bootcamp@sha256:fb1a3ced00cecfc1f83f18ab5cd14199e30adc1b49aa4244f5d65ad3f5feb2a5
    Port:           <none>
    Host Port:      <none>
    State:          Running
      Started:      Thu, 04 May 2023 15:10:30 +0900
    Ready:          True
    Restart Count:  0
    Environment:    <none>
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-jvlmr (ro)
Conditions:
  Type              Status
  Initialized       True
  Ready             True
  ContainersReady   True
  PodScheduled      True
Volumes:
  kube-api-access-jvlmr:
    Type:                    Projected (a volume that contains injected data from multiple sources)
    TokenExpirationSeconds:  3607
    ConfigMapName:           kube-root-ca.crt
    ConfigMapOptional:       <nil>
    DownwardAPI:             true
QoS Class:                   BestEffort
Node-Selectors:              <none>
Tolerations:                 node.kubernetes.io/not-ready:NoExecute op=Exists for 300s
                             node.kubernetes.io/unreachable:NoExecute op=Exists for 300s
Events:
  Type    Reason     Age    From               Message
  ----    ------     ----   ----               -------
  Normal  Scheduled  9m30s  default-scheduler  Successfully assigned default/kubernetes-bootcamp-69b6f9fbb9-s72bb to k8s-worker1.localdomain
  Normal  Pulled     9m30s  kubelet            Container image "jocatalin/kubernetes-bootcamp:v2" already present on machine
  Normal  Created    9m30s  kubelet            Created container kubernetes-bootcamp
  Normal  Started    9m29s  kubelet            Started container kubernetes-bootcamp
```

</details>
<br>
ポッドで実行するイメージを v2 から v10 に更新

_v10 を持つイメージはリポジトリに存在しないためエラーとなる_

```bash
$ kubectl set image deployments/kubernetes-bootcamp kubernetes-bootcamp=gcr.io/google-samples/kubernetes-bootcamp:v10
deployment.apps/kubernetes-bootcamp image updated
```

デプロイメントの状態を確認

```bash
$ kubectl get deployments
NAME                  READY   UP-TO-DATE   AVAILABLE   AGE
kubernetes-bootcamp   3/4     2            3           28m
```

_`READY`の数が一致していない_

ポッドの状態を確認する

```bash
$ kubectl get pods
NAME                                   READY   STATUS             RESTARTS   AGE
kubernetes-bootcamp-66566cb7f-7bbfj    0/1     ImagePullBackOff   0          3m30s
kubernetes-bootcamp-66566cb7f-fhccv    0/1     ImagePullBackOff   0          3m30s
kubernetes-bootcamp-69b6f9fbb9-8g9jp   1/1     Running            0          22m
kubernetes-bootcamp-69b6f9fbb9-p4xvf   1/1     Running            0          22m
kubernetes-bootcamp-69b6f9fbb9-prszg   1/1     Running            0          22m
```

_いくつかのポッドが`ImagePullBackOff`となっている_

ポッドのイベントログを確認

```bash
$ kubectl describe pods
```

<details><summary>実行結果</summary>

```bash
$ kubectl describe pods
Name:             kubernetes-bootcamp-66566cb7f-7bbfj
Namespace:        default
Priority:         0
Service Account:  default
Node:             k8s-worker1.localdomain/192.168.122.193
Start Time:       Thu, 04 May 2023 15:29:24 +0900
Labels:           app=kubernetes-bootcamp
                  pod-template-hash=66566cb7f
Annotations:      cni.projectcalico.org/containerID: 2b44c0f8ee78bffef044b70ef859e2a2ad2c612fbc898616dd8703263f58f653
                  cni.projectcalico.org/podIP: 172.16.55.77/32
                  cni.projectcalico.org/podIPs: 172.16.55.77/32
Status:           Pending
IP:               172.16.55.77
IPs:
  IP:           172.16.55.77
Controlled By:  ReplicaSet/kubernetes-bootcamp-66566cb7f
Containers:
  kubernetes-bootcamp:
    Container ID:
    Image:          gcr.io/google-samples/kubernetes-bootcamp:v10
    Image ID:
    Port:           <none>
    Host Port:      <none>
    State:          Waiting
      Reason:       ImagePullBackOff
    Ready:          False
    Restart Count:  0
    Environment:    <none>
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-np87g (ro)
Conditions:
  Type              Status
  Initialized       True
  Ready             False
  ContainersReady   False
  PodScheduled      True
Volumes:
  kube-api-access-np87g:
    Type:                    Projected (a volume that contains injected data from multiple sources)
    TokenExpirationSeconds:  3607
    ConfigMapName:           kube-root-ca.crt
    ConfigMapOptional:       <nil>
    DownwardAPI:             true
QoS Class:                   BestEffort
Node-Selectors:              <none>
Tolerations:                 node.kubernetes.io/not-ready:NoExecute op=Exists for 300s
                             node.kubernetes.io/unreachable:NoExecute op=Exists for 300s
Events:
  Type     Reason     Age                    From               Message
  ----     ------     ----                   ----               -------
  Normal   Scheduled  6m36s                  default-scheduler  Successfully assigned default/kubernetes-bootcamp-66566cb7f-7bbfj to k8s-worker1.localdomain
  Normal   Pulling    5m7s (x4 over 6m35s)   kubelet            Pulling image "gcr.io/google-samples/kubernetes-bootcamp:v10"
  Warning  Failed     5m7s (x4 over 6m34s)   kubelet            Failed to pull image "gcr.io/google-samples/kubernetes-bootcamp:v10": rpc error: code = NotFound desc = failed to pull and unpack image "gcr.io/google-samples/kubernetes-bootcamp:v10": failed to resolve reference "gcr.io/google-samples/kubernetes-bootcamp:v10": gcr.io/google-samples/kubernetes-bootcamp:v10: not found
  Warning  Failed     5m7s (x4 over 6m34s)   kubelet            Error: ErrImagePull
  Warning  Failed     4m55s (x6 over 6m34s)  kubelet            Error: ImagePullBackOff
  Normal   BackOff    82s (x21 over 6m34s)   kubelet            Back-off pulling image "gcr.io/google-samples/kubernetes-bootcamp:v10"


Name:             kubernetes-bootcamp-66566cb7f-fhccv
Namespace:        default
Priority:         0
Service Account:  default
Node:             k8s-worker2.localdomain/192.168.122.150
Start Time:       Thu, 04 May 2023 15:29:24 +0900
Labels:           app=kubernetes-bootcamp
                  pod-template-hash=66566cb7f
Annotations:      cni.projectcalico.org/containerID: 1d1e7f0ded28377426a1c54d143e4fe71c849a3c3b4dac3be9be606bd0949223
                  cni.projectcalico.org/podIP: 172.16.219.207/32
                  cni.projectcalico.org/podIPs: 172.16.219.207/32
Status:           Pending
IP:               172.16.219.207
IPs:
  IP:           172.16.219.207
Controlled By:  ReplicaSet/kubernetes-bootcamp-66566cb7f
Containers:
  kubernetes-bootcamp:
    Container ID:
    Image:          gcr.io/google-samples/kubernetes-bootcamp:v10
    Image ID:
    Port:           <none>
    Host Port:      <none>
    State:          Waiting
      Reason:       ImagePullBackOff
    Ready:          False
    Restart Count:  0
    Environment:    <none>
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-gwfbw (ro)
Conditions:
  Type              Status
  Initialized       True
  Ready             False
  ContainersReady   False
  PodScheduled      True
Volumes:
  kube-api-access-gwfbw:
    Type:                    Projected (a volume that contains injected data from multiple sources)
    TokenExpirationSeconds:  3607
    ConfigMapName:           kube-root-ca.crt
    ConfigMapOptional:       <nil>
    DownwardAPI:             true
QoS Class:                   BestEffort
Node-Selectors:              <none>
Tolerations:                 node.kubernetes.io/not-ready:NoExecute op=Exists for 300s
                             node.kubernetes.io/unreachable:NoExecute op=Exists for 300s
Events:
  Type     Reason     Age                    From               Message
  ----     ------     ----                   ----               -------
  Normal   Scheduled  6m36s                  default-scheduler  Successfully assigned default/kubernetes-bootcamp-66566cb7f-fhccv to k8s-worker2.localdomain
  Normal   Pulling    5m11s (x4 over 6m35s)  kubelet            Pulling image "gcr.io/google-samples/kubernetes-bootcamp:v10"
  Warning  Failed     5m10s (x4 over 6m35s)  kubelet            Failed to pull image "gcr.io/google-samples/kubernetes-bootcamp:v10": rpc error: code = NotFound desc = failed to pull and unpack image "gcr.io/google-samples/kubernetes-bootcamp:v10": failed to resolve reference "gcr.io/google-samples/kubernetes-bootcamp:v10": gcr.io/google-samples/kubernetes-bootcamp:v10: not found
  Warning  Failed     5m10s (x4 over 6m35s)  kubelet            Error: ErrImagePull
  Warning  Failed     4m46s (x6 over 6m34s)  kubelet            Error: ImagePullBackOff
  Normal   BackOff    83s (x21 over 6m34s)   kubelet            Back-off pulling image "gcr.io/google-samples/kubernetes-bootcamp:v10"


Name:             kubernetes-bootcamp-69b6f9fbb9-8g9jp
Namespace:        default
Priority:         0
Service Account:  default
Node:             k8s-worker1.localdomain/192.168.122.193
Start Time:       Thu, 04 May 2023 15:10:23 +0900
Labels:           app=kubernetes-bootcamp
                  pod-template-hash=69b6f9fbb9
Annotations:      cni.projectcalico.org/containerID: f6209c1264d9c794d0ec0995d45206f202771458612589ad8ffb3d518f3c35e9
                  cni.projectcalico.org/podIP: 172.16.55.75/32
                  cni.projectcalico.org/podIPs: 172.16.55.75/32
Status:           Running
IP:               172.16.55.75
IPs:
  IP:           172.16.55.75
Controlled By:  ReplicaSet/kubernetes-bootcamp-69b6f9fbb9
Containers:
  kubernetes-bootcamp:
    Container ID:   containerd://f3f23effa036a42830b23e5d819d391d4a9db34cd25ab632db9c8e5f90ba9f26
    Image:          jocatalin/kubernetes-bootcamp:v2
    Image ID:       docker.io/jocatalin/kubernetes-bootcamp@sha256:fb1a3ced00cecfc1f83f18ab5cd14199e30adc1b49aa4244f5d65ad3f5feb2a5
    Port:           <none>
    Host Port:      <none>
    State:          Running
      Started:      Thu, 04 May 2023 15:10:28 +0900
    Ready:          True
    Restart Count:  0
    Environment:    <none>
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-mskkv (ro)
Conditions:
  Type              Status
  Initialized       True
  Ready             True
  ContainersReady   True
  PodScheduled      True
Volumes:
  kube-api-access-mskkv:
    Type:                    Projected (a volume that contains injected data from multiple sources)
    TokenExpirationSeconds:  3607
    ConfigMapName:           kube-root-ca.crt
    ConfigMapOptional:       <nil>
    DownwardAPI:             true
QoS Class:                   BestEffort
Node-Selectors:              <none>
Tolerations:                 node.kubernetes.io/not-ready:NoExecute op=Exists for 300s
                             node.kubernetes.io/unreachable:NoExecute op=Exists for 300s
Events:
  Type    Reason     Age   From               Message
  ----    ------     ----  ----               -------
  Normal  Scheduled  25m   default-scheduler  Successfully assigned default/kubernetes-bootcamp-69b6f9fbb9-8g9jp to k8s-worker1.localdomain
  Normal  Pulling    25m   kubelet            Pulling image "jocatalin/kubernetes-bootcamp:v2"
  Normal  Pulled     25m   kubelet            Successfully pulled image "jocatalin/kubernetes-bootcamp:v2" in 4.644163467s (4.644169821s including waiting)
  Normal  Created    25m   kubelet            Created container kubernetes-bootcamp
  Normal  Started    25m   kubelet            Started container kubernetes-bootcamp


Name:             kubernetes-bootcamp-69b6f9fbb9-p4xvf
Namespace:        default
Priority:         0
Service Account:  default
Node:             k8s-worker2.localdomain/192.168.122.150
Start Time:       Thu, 04 May 2023 15:10:22 +0900
Labels:           app=kubernetes-bootcamp
                  pod-template-hash=69b6f9fbb9
Annotations:      cni.projectcalico.org/containerID: 9c024d686c9f738f7e43c1b7cb37a25ff3722e6c1c785d651ccec32dfb2b19c1
                  cni.projectcalico.org/podIP: 172.16.219.205/32
                  cni.projectcalico.org/podIPs: 172.16.219.205/32
Status:           Running
IP:               172.16.219.205
IPs:
  IP:           172.16.219.205
Controlled By:  ReplicaSet/kubernetes-bootcamp-69b6f9fbb9
Containers:
  kubernetes-bootcamp:
    Container ID:   containerd://56cfe8176a53ff4e4c0624a2c742d0f704a3161f8366eff2dd713a60d49a2d91
    Image:          jocatalin/kubernetes-bootcamp:v2
    Image ID:       docker.io/jocatalin/kubernetes-bootcamp@sha256:fb1a3ced00cecfc1f83f18ab5cd14199e30adc1b49aa4244f5d65ad3f5feb2a5
    Port:           <none>
    Host Port:      <none>
    State:          Running
      Started:      Thu, 04 May 2023 15:10:28 +0900
    Ready:          True
    Restart Count:  0
    Environment:    <none>
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-gvch8 (ro)
Conditions:
  Type              Status
  Initialized       True
  Ready             True
  ContainersReady   True
  PodScheduled      True
Volumes:
  kube-api-access-gvch8:
    Type:                    Projected (a volume that contains injected data from multiple sources)
    TokenExpirationSeconds:  3607
    ConfigMapName:           kube-root-ca.crt
    ConfigMapOptional:       <nil>
    DownwardAPI:             true
QoS Class:                   BestEffort
Node-Selectors:              <none>
Tolerations:                 node.kubernetes.io/not-ready:NoExecute op=Exists for 300s
                             node.kubernetes.io/unreachable:NoExecute op=Exists for 300s
Events:
  Type    Reason     Age   From               Message
  ----    ------     ----  ----               -------
  Normal  Scheduled  25m   default-scheduler  Successfully assigned default/kubernetes-bootcamp-69b6f9fbb9-p4xvf to k8s-worker2.localdomain
  Normal  Pulling    25m   kubelet            Pulling image "jocatalin/kubernetes-bootcamp:v2"
  Normal  Pulled     25m   kubelet            Successfully pulled image "jocatalin/kubernetes-bootcamp:v2" in 4.737592103s (4.737597887s including waiting)
  Normal  Created    25m   kubelet            Created container kubernetes-bootcamp
  Normal  Started    25m   kubelet            Started container kubernetes-bootcamp


Name:             kubernetes-bootcamp-69b6f9fbb9-prszg
Namespace:        default
Priority:         0
Service Account:  default
Node:             k8s-worker2.localdomain/192.168.122.150
Start Time:       Thu, 04 May 2023 15:10:29 +0900
Labels:           app=kubernetes-bootcamp
                  pod-template-hash=69b6f9fbb9
Annotations:      cni.projectcalico.org/containerID: 5aafb6a17c463e08a7af2b74513c4b88ba66de0fe653948b853ed481ef821339
                  cni.projectcalico.org/podIP: 172.16.219.206/32
                  cni.projectcalico.org/podIPs: 172.16.219.206/32
Status:           Running
IP:               172.16.219.206
IPs:
  IP:           172.16.219.206
Controlled By:  ReplicaSet/kubernetes-bootcamp-69b6f9fbb9
Containers:
  kubernetes-bootcamp:
    Container ID:   containerd://045beaa86f73c5657cad679cddbbbcea7a2cbbcf843d67fa7bc4978a117ef658
    Image:          jocatalin/kubernetes-bootcamp:v2
    Image ID:       docker.io/jocatalin/kubernetes-bootcamp@sha256:fb1a3ced00cecfc1f83f18ab5cd14199e30adc1b49aa4244f5d65ad3f5feb2a5
    Port:           <none>
    Host Port:      <none>
    State:          Running
      Started:      Thu, 04 May 2023 15:10:29 +0900
    Ready:          True
    Restart Count:  0
    Environment:    <none>
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-rmvdm (ro)
Conditions:
  Type              Status
  Initialized       True
  Ready             True
  ContainersReady   True
  PodScheduled      True
Volumes:
  kube-api-access-rmvdm:
    Type:                    Projected (a volume that contains injected data from multiple sources)
    TokenExpirationSeconds:  3607
    ConfigMapName:           kube-root-ca.crt
    ConfigMapOptional:       <nil>
    DownwardAPI:             true
QoS Class:                   BestEffort
Node-Selectors:              <none>
Tolerations:                 node.kubernetes.io/not-ready:NoExecute op=Exists for 300s
                             node.kubernetes.io/unreachable:NoExecute op=Exists for 300s
Events:
  Type    Reason     Age   From               Message
  ----    ------     ----  ----               -------
  Normal  Scheduled  25m   default-scheduler  Successfully assigned default/kubernetes-bootcamp-69b6f9fbb9-prszg to k8s-worker2.localdomain
  Normal  Pulled     25m   kubelet            Container image "jocatalin/kubernetes-bootcamp:v2" already present on machine
  Normal  Created    25m   kubelet            Created container kubernetes-bootcamp
  Normal  Started    25m   kubelet            Started container kubernetes-bootcamp
```

</details>

_一部のポッドで`Failure`イベントを記録している_
<br>
ロールアウトを取り消す（ロールバック）

```bash
$ kubectl rollout undo deployments/kubernetes-bootcamp
deployment.apps/kubernetes-bootcamp rolled back
```

ポッドの状態を確認

```bash
$ kubectl get pods
NAME                                   READY   STATUS    RESTARTS   AGE
kubernetes-bootcamp-69b6f9fbb9-8g9jp   1/1     Running   0          32m
kubernetes-bootcamp-69b6f9fbb9-9l642   1/1     Running   0          106s
kubernetes-bootcamp-69b6f9fbb9-p4xvf   1/1     Running   0          32m
kubernetes-bootcamp-69b6f9fbb9-prszg   1/1     Running   0          32m
```

ポッドのイベントログを確認

```bash
$ kubectl descrive pods
```

<details><summary>実行結果</summary>

```bash
$ kubectl descrive pods
error: unknown command "descrive" for "kubectl"

Did you mean this?
	describe
[bravog@bravo55 ~]$ kubectl describe pods
Name:             kubernetes-bootcamp-69b6f9fbb9-8g9jp
Namespace:        default
Priority:         0
Service Account:  default
Node:             k8s-worker1.localdomain/192.168.122.193
Start Time:       Thu, 04 May 2023 15:10:23 +0900
Labels:           app=kubernetes-bootcamp
                  pod-template-hash=69b6f9fbb9
Annotations:      cni.projectcalico.org/containerID: f6209c1264d9c794d0ec0995d45206f202771458612589ad8ffb3d518f3c35e9
                  cni.projectcalico.org/podIP: 172.16.55.75/32
                  cni.projectcalico.org/podIPs: 172.16.55.75/32
Status:           Running
IP:               172.16.55.75
IPs:
  IP:           172.16.55.75
Controlled By:  ReplicaSet/kubernetes-bootcamp-69b6f9fbb9
Containers:
  kubernetes-bootcamp:
    Container ID:   containerd://f3f23effa036a42830b23e5d819d391d4a9db34cd25ab632db9c8e5f90ba9f26
    Image:          jocatalin/kubernetes-bootcamp:v2
    Image ID:       docker.io/jocatalin/kubernetes-bootcamp@sha256:fb1a3ced00cecfc1f83f18ab5cd14199e30adc1b49aa4244f5d65ad3f5feb2a5
    Port:           <none>
    Host Port:      <none>
    State:          Running
      Started:      Thu, 04 May 2023 15:10:28 +0900
    Ready:          True
    Restart Count:  0
    Environment:    <none>
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-mskkv (ro)
Conditions:
  Type              Status
  Initialized       True
  Ready             True
  ContainersReady   True
  PodScheduled      True
Volumes:
  kube-api-access-mskkv:
    Type:                    Projected (a volume that contains injected data from multiple sources)
    TokenExpirationSeconds:  3607
    ConfigMapName:           kube-root-ca.crt
    ConfigMapOptional:       <nil>
    DownwardAPI:             true
QoS Class:                   BestEffort
Node-Selectors:              <none>
Tolerations:                 node.kubernetes.io/not-ready:NoExecute op=Exists for 300s
                             node.kubernetes.io/unreachable:NoExecute op=Exists for 300s
Events:
  Type    Reason     Age   From               Message
  ----    ------     ----  ----               -------
  Normal  Scheduled  33m   default-scheduler  Successfully assigned default/kubernetes-bootcamp-69b6f9fbb9-8g9jp to k8s-worker1.localdomain
  Normal  Pulling    33m   kubelet            Pulling image "jocatalin/kubernetes-bootcamp:v2"
  Normal  Pulled     33m   kubelet            Successfully pulled image "jocatalin/kubernetes-bootcamp:v2" in 4.644163467s (4.644169821s including waiting)
  Normal  Created    33m   kubelet            Created container kubernetes-bootcamp
  Normal  Started    33m   kubelet            Started container kubernetes-bootcamp


Name:             kubernetes-bootcamp-69b6f9fbb9-9l642
Namespace:        default
Priority:         0
Service Account:  default
Node:             k8s-worker1.localdomain/192.168.122.193
Start Time:       Thu, 04 May 2023 15:41:19 +0900
Labels:           app=kubernetes-bootcamp
                  pod-template-hash=69b6f9fbb9
Annotations:      cni.projectcalico.org/containerID: e278d72913fde46b9dfc82fa3570c412d7e461d799178d91cdf66f01be00d94d
                  cni.projectcalico.org/podIP: 172.16.55.78/32
                  cni.projectcalico.org/podIPs: 172.16.55.78/32
Status:           Running
IP:               172.16.55.78
IPs:
  IP:           172.16.55.78
Controlled By:  ReplicaSet/kubernetes-bootcamp-69b6f9fbb9
Containers:
  kubernetes-bootcamp:
    Container ID:   containerd://aae6d450b2735c9d88999015556e6f8141b7f4ad941a8000a43d3654bd462c59
    Image:          jocatalin/kubernetes-bootcamp:v2
    Image ID:       docker.io/jocatalin/kubernetes-bootcamp@sha256:fb1a3ced00cecfc1f83f18ab5cd14199e30adc1b49aa4244f5d65ad3f5feb2a5
    Port:           <none>
    Host Port:      <none>
    State:          Running
      Started:      Thu, 04 May 2023 15:41:20 +0900
    Ready:          True
    Restart Count:  0
    Environment:    <none>
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-cb6vc (ro)
Conditions:
  Type              Status
  Initialized       True
  Ready             True
  ContainersReady   True
  PodScheduled      True
Volumes:
  kube-api-access-cb6vc:
    Type:                    Projected (a volume that contains injected data from multiple sources)
    TokenExpirationSeconds:  3607
    ConfigMapName:           kube-root-ca.crt
    ConfigMapOptional:       <nil>
    DownwardAPI:             true
QoS Class:                   BestEffort
Node-Selectors:              <none>
Tolerations:                 node.kubernetes.io/not-ready:NoExecute op=Exists for 300s
                             node.kubernetes.io/unreachable:NoExecute op=Exists for 300s
Events:
  Type    Reason     Age    From               Message
  ----    ------     ----   ----               -------
  Normal  Scheduled  2m54s  default-scheduler  Successfully assigned default/kubernetes-bootcamp-69b6f9fbb9-9l642 to k8s-worker1.localdomain
  Normal  Pulled     2m53s  kubelet            Container image "jocatalin/kubernetes-bootcamp:v2" already present on machine
  Normal  Created    2m53s  kubelet            Created container kubernetes-bootcamp
  Normal  Started    2m53s  kubelet            Started container kubernetes-bootcamp


Name:             kubernetes-bootcamp-69b6f9fbb9-p4xvf
Namespace:        default
Priority:         0
Service Account:  default
Node:             k8s-worker2.localdomain/192.168.122.150
Start Time:       Thu, 04 May 2023 15:10:22 +0900
Labels:           app=kubernetes-bootcamp
                  pod-template-hash=69b6f9fbb9
Annotations:      cni.projectcalico.org/containerID: 9c024d686c9f738f7e43c1b7cb37a25ff3722e6c1c785d651ccec32dfb2b19c1
                  cni.projectcalico.org/podIP: 172.16.219.205/32
                  cni.projectcalico.org/podIPs: 172.16.219.205/32
Status:           Running
IP:               172.16.219.205
IPs:
  IP:           172.16.219.205
Controlled By:  ReplicaSet/kubernetes-bootcamp-69b6f9fbb9
Containers:
  kubernetes-bootcamp:
    Container ID:   containerd://56cfe8176a53ff4e4c0624a2c742d0f704a3161f8366eff2dd713a60d49a2d91
    Image:          jocatalin/kubernetes-bootcamp:v2
    Image ID:       docker.io/jocatalin/kubernetes-bootcamp@sha256:fb1a3ced00cecfc1f83f18ab5cd14199e30adc1b49aa4244f5d65ad3f5feb2a5
    Port:           <none>
    Host Port:      <none>
    State:          Running
      Started:      Thu, 04 May 2023 15:10:28 +0900
    Ready:          True
    Restart Count:  0
    Environment:    <none>
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-gvch8 (ro)
Conditions:
  Type              Status
  Initialized       True
  Ready             True
  ContainersReady   True
  PodScheduled      True
Volumes:
  kube-api-access-gvch8:
    Type:                    Projected (a volume that contains injected data from multiple sources)
    TokenExpirationSeconds:  3607
    ConfigMapName:           kube-root-ca.crt
    ConfigMapOptional:       <nil>
    DownwardAPI:             true
QoS Class:                   BestEffort
Node-Selectors:              <none>
Tolerations:                 node.kubernetes.io/not-ready:NoExecute op=Exists for 300s
                             node.kubernetes.io/unreachable:NoExecute op=Exists for 300s
Events:
  Type    Reason     Age   From               Message
  ----    ------     ----  ----               -------
  Normal  Scheduled  33m   default-scheduler  Successfully assigned default/kubernetes-bootcamp-69b6f9fbb9-p4xvf to k8s-worker2.localdomain
  Normal  Pulling    33m   kubelet            Pulling image "jocatalin/kubernetes-bootcamp:v2"
  Normal  Pulled     33m   kubelet            Successfully pulled image "jocatalin/kubernetes-bootcamp:v2" in 4.737592103s (4.737597887s including waiting)
  Normal  Created    33m   kubelet            Created container kubernetes-bootcamp
  Normal  Started    33m   kubelet            Started container kubernetes-bootcamp


Name:             kubernetes-bootcamp-69b6f9fbb9-prszg
Namespace:        default
Priority:         0
Service Account:  default
Node:             k8s-worker2.localdomain/192.168.122.150
Start Time:       Thu, 04 May 2023 15:10:29 +0900
Labels:           app=kubernetes-bootcamp
                  pod-template-hash=69b6f9fbb9
Annotations:      cni.projectcalico.org/containerID: 5aafb6a17c463e08a7af2b74513c4b88ba66de0fe653948b853ed481ef821339
                  cni.projectcalico.org/podIP: 172.16.219.206/32
                  cni.projectcalico.org/podIPs: 172.16.219.206/32
Status:           Running
IP:               172.16.219.206
IPs:
  IP:           172.16.219.206
Controlled By:  ReplicaSet/kubernetes-bootcamp-69b6f9fbb9
Containers:
  kubernetes-bootcamp:
    Container ID:   containerd://045beaa86f73c5657cad679cddbbbcea7a2cbbcf843d67fa7bc4978a117ef658
    Image:          jocatalin/kubernetes-bootcamp:v2
    Image ID:       docker.io/jocatalin/kubernetes-bootcamp@sha256:fb1a3ced00cecfc1f83f18ab5cd14199e30adc1b49aa4244f5d65ad3f5feb2a5
    Port:           <none>
    Host Port:      <none>
    State:          Running
      Started:      Thu, 04 May 2023 15:10:29 +0900
    Ready:          True
    Restart Count:  0
    Environment:    <none>
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-rmvdm (ro)
Conditions:
  Type              Status
  Initialized       True
  Ready             True
  ContainersReady   True
  PodScheduled      True
Volumes:
  kube-api-access-rmvdm:
    Type:                    Projected (a volume that contains injected data from multiple sources)
    TokenExpirationSeconds:  3607
    ConfigMapName:           kube-root-ca.crt
    ConfigMapOptional:       <nil>
    DownwardAPI:             true
QoS Class:                   BestEffort
Node-Selectors:              <none>
Tolerations:                 node.kubernetes.io/not-ready:NoExecute op=Exists for 300s
                             node.kubernetes.io/unreachable:NoExecute op=Exists for 300s
Events:
  Type    Reason     Age   From               Message
  ----    ------     ----  ----               -------
  Normal  Scheduled  33m   default-scheduler  Successfully assigned default/kubernetes-bootcamp-69b6f9fbb9-prszg to k8s-worker2.localdomain
  Normal  Pulled     33m   kubelet            Container image "jocatalin/kubernetes-bootcamp:v2" already present on machine
  Normal  Created    33m   kubelet            Created container kubernetes-bootcamp
  Normal  Started    33m   kubelet            Started container kubernetes-bootcamp
```

</details>

_ロールバック操作により v2 に戻っている_
<br>
デプロイメントを削除

```bash
$ kubectl delete deployment kubernetes-bootcamp
```

ノードポートサービスを削除

```bash
$ kubectl delete service kubernetes-bootcamp
```
